# 03. 도메인 모델 설계

## 1. 개요

헥사고날 아키텍처 기반으로 도메인 모델을 설계합니다. 도메인 중심 설계(DDD) 원칙을 적용하여 비즈니스 로직이 도메인 모델에 집중되도록 합니다.

## 2. 도메인 모델 구조

### 2.1 패키지 구조

```
com.musinsa.payments.point.domain
├── entity          # 도메인 엔티티
├── valueobject     # 값 객체
├── service         # 도메인 서비스
├── event           # 도메인 이벤트
└── exception       # 도메인 예외

참고: 리포지토리 인터페이스(포트)는 Domain 레이어가 아닌 Application 레이어의 
application.port.output.persistence 패키지에 정의됩니다.
```

## 3. 엔티티 설계

### 3.1 PointAccumulation (포인트 적립)

**책임**: 포인트 적립 정보 및 비즈니스 로직 관리

**주요 속성**:

| 속성              | 타입                      | 설명                |
|-----------------|-------------------------|-------------------|
| id              | Long?                   | 엔티티 ID (저장 후 할당)  |
| pointKey        | String                  | 비즈니스 식별자 (UNIQUE) |
| memberId        | Long                    | 사용자 ID            |
| amount          | Money                   | 적립 금액             |
| availableAmount | Money                   | 사용 가능 잔액          |
| expirationDate  | LocalDate               | 만료일               |
| isManualGrant   | Boolean                 | 수기 지급 여부          |
| status          | PointAccumulationStatus | 상태                |
| createdAt       | LocalDateTime           | 생성일시              |
| updatedAt       | LocalDateTime           | 수정일시              |

**주요 기능**:

| 메서드                  | 설명                                            |
|----------------------|-----------------------------------------------|
| canBeCancelled()     | 취소 가능 여부 확인 (상태가 ACCUMULATED이고 사용된 금액이 없어야 함) |
| isExpired()          | 현재 시점 기준 만료 여부 확인                             |
| isExpiredAt(date)    | 특정 날짜 기준 만료 여부 확인                             |
| use(amount)          | 포인트 사용 처리 (사용 가능 잔액 차감)                       |
| cancel()             | 적립 취소 처리                                      |
| markAsExpired()      | 만료 처리                                         |
| hasAvailableAmount() | 사용 가능 잔액 존재 여부 확인                             |
| restore(amount)      | 포인트 복원 처리 (사용 취소 시)                           |

**비즈니스 규칙**:
- 적립 금액은 0보다 커야 함
- 만료일은 오늘 이후여야 함
- 사용된 금액이 있으면 적립 취소 불가
- 복원 후 사용 가능 잔액은 적립 금액을 초과할 수 없음

---

### 3.2 PointUsage (포인트 사용)

**책임**: 포인트 사용 정보 및 취소 처리 관리

**주요 속성**:

| 속성              | 타입               | 설명                |
|-----------------|------------------|-------------------|
| id              | Long?            | 엔티티 ID (저장 후 할당)  |
| pointKey        | String           | 비즈니스 식별자 (UNIQUE) |
| memberId        | Long             | 사용자 ID            |
| orderNumber     | OrderNumber      | 주문번호              |
| totalAmount     | Money            | 총 사용 금액           |
| cancelledAmount | Money            | 취소된 금액            |
| status          | PointUsageStatus | 상태                |
| createdAt       | LocalDateTime    | 생성일시              |
| updatedAt       | LocalDateTime    | 수정일시              |

**주요 기능**:

| 메서드                  | 설명                                          |
|----------------------|---------------------------------------------|
| getRemainingAmount() | 남은 사용 금액 계산 (totalAmount - cancelledAmount) |
| canCancel(amount)    | 취소 가능 여부 확인                                 |
| cancel(amount)       | 사용 취소 처리 (부분 취소 지원)                         |

**비즈니스 규칙**:
- 총 사용 금액은 0보다 커야 함
- 취소 금액은 총 사용 금액을 초과할 수 없음
- 취소 시 상태 자동 업데이트 (PARTIALLY_CANCELLED, FULLY_CANCELLED)

---

### 3.3 PointUsageDetail (포인트 사용 상세)

**책임**: 1포인트 단위 사용 추적 관리

**주요 속성**:

| 속성                  | 타입            | 설명               |
|---------------------|---------------|------------------|
| id                  | Long?         | 엔티티 ID (저장 후 할당) |
| pointUsageId        | Long          | 포인트 사용 ID (FK)   |
| pointAccumulationId | Long          | 포인트 적립 ID (FK)   |
| amount              | Money         | 사용 금액 (1포인트 단위)  |
| cancelledAmount     | Money         | 취소된 금액           |
| createdAt           | LocalDateTime | 생성일시             |
| updatedAt           | LocalDateTime | 수정일시             |

**주요 기능**:

| 메서드                  | 설명          |
|----------------------|-------------|
| getRemainingAmount() | 남은 금액 계산    |
| cancel(amount)       | 상세 내역 취소 처리 |
| isFullyCancelled()   | 전체 취소 여부 확인 |

**비즈니스 규칙**:
- 어떤 적립 건에서 얼마를 사용했는지 1포인트 단위로 추적
- 취소 금액은 사용 금액을 초과할 수 없음

---

### 3.4 PointConfig (포인트 설정)

**책임**: 동적 설정 값 관리

**주요 속성**:

| 속성          | 타입            | 설명               |
|-------------|---------------|------------------|
| id          | Long?         | 엔티티 ID (저장 후 할당) |
| configKey   | String        | 설정 키 (UNIQUE)    |
| configValue | String        | 설정 값             |
| description | String?       | 설명 (선택)          |
| createdAt   | LocalDateTime | 생성일시             |
| updatedAt   | LocalDateTime | 수정일시             |

**주요 기능**:

| 메서드                      | 설명                    |
|--------------------------|-----------------------|
| getLongValue()           | 설정 값을 Long 타입으로 변환    |
| getIntValue()            | 설정 값을 Int 타입으로 변환     |
| getBooleanValue()        | 설정 값을 Boolean 타입으로 변환 |
| updateConfigValue(value) | 설정 값 업데이트             |

**주요 설정 키**:

| 설정 키                             | 설명           | 기본값          |
|----------------------------------|--------------|--------------|
| MAX_ACCUMULATION_AMOUNT_PER_TIME | 1회 최대 적립 금액  | 100,000      |
| MAX_BALANCE_PER_MEMBER           | 개인별 최대 보유 금액 | -            |
| DEFAULT_EXPIRATION_DAYS          | 기본 만료일       | 365          |
| MIN_EXPIRATION_DAYS              | 최소 만료일       | 1            |
| MAX_EXPIRATION_DAYS              | 최대 만료일       | 1,824 (약 5년) |

---

### 3.5 PointConfigHistory (포인트 설정 변경 이력)

**책임**: 포인트 설정 변경 이력 추적

**주요 속성**:

| 속성        | 타입            | 설명                  |
|-----------|---------------|---------------------|
| id        | Long?         | 엔티티 ID (저장 후 할당)    |
| configKey | String        | 설정 키 (FK)           |
| oldValue  | String?       | 이전 값 (최초 생성 시 null) |
| newValue  | String        | 새로운 값               |
| changedBy | String?       | 변경한 사용자 (선택)        |
| changedAt | LocalDateTime | 변경일시                |

**비즈니스 규칙**:
- 설정 변경 시 이력 자동 생성
- 이력은 수정/삭제 불가 (감사 목적)

---

### 3.6 MemberPointBalance (회원 포인트 잔액)

**책임**: 회원별 포인트 잔액 캐시 관리

**주요 속성**:

| 속성               | 타입            | 설명          |
|------------------|---------------|-------------|
| memberId         | Long          | 사용자 ID (PK) |
| availableBalance | Money         | 사용 가능 잔액    |
| totalAccumulated | Money         | 총 적립액       |
| totalUsed        | Money         | 총 사용액       |
| totalExpired     | Money         | 총 만료액       |
| version          | Long          | 버전 (낙관적 잠금) |
| createdAt        | LocalDateTime | 생성일시        |
| updatedAt        | LocalDateTime | 수정일시        |

**주요 기능**:

| 메서드                        | 설명                |
|----------------------------|-------------------|
| addBalance(amount)         | 포인트 적립 처리         |
| subtractBalance(amount)    | 포인트 사용 처리         |
| restoreBalance(amount)     | 포인트 복원 처리 (사용 취소) |
| cancelAccumulation(amount) | 적립 취소 처리          |
| expireBalance(amount)      | 포인트 만료 처리         |
| reconcile(actualBalance)   | 잔액 보정 처리          |

**특이사항**:
- 캐시 테이블로, 비동기 이벤트 기반으로 잔액 관리
- 이벤트 처리 순서가 보장되지 않아 음수가 될 수 있음
- 실제 잔액 검증은 서비스 레이어에서 수행
- reconciliation 서비스에서 주기적으로 정합성 보정

---

## 4. 값 객체 (Value Object) 설계

### 4.1 Money (금액)

**책임**: 금액을 표현하는 불변 객체

**특징**:
- 불변 객체 (Immutable)
- 금액은 0 이상이어야 함
- 소수점 이하 절삭 (RoundingMode.DOWN)

**주요 기능**:

| 메서드                         | 설명                 |
|-----------------------------|--------------------|
| of(amount: Long)            | 정적 팩토리 메서드         |
| of(amount: BigDecimal)      | 정적 팩토리 메서드         |
| add(other)                  | 금액 덧셈              |
| subtract(other)             | 금액 뺄셈              |
| isGreaterThan(other)        | 크기 비교 (>)          |
| isGreaterThanOrEqual(other) | 크기 비교 (>=)         |
| isLessThan(other)           | 크기 비교 (<)          |
| isLessThanOrEqual(other)    | 크기 비교 (<=)         |
| toLong()                    | Long 타입으로 변환       |
| toBigDecimal()              | BigDecimal 타입으로 변환 |

**상수**:
- `Money.ZERO`: 0원을 나타내는 상수

---

### 4.2 OrderNumber (주문번호)

**책임**: 주문번호를 표현하는 불변 객체

**특징**:
- 불변 객체
- 주문번호 검증 로직 포함

**주요 기능**:

| 메서드               | 설명                  |
|-------------------|---------------------|
| of(value: String) | 정적 팩토리 메서드 (빈 값 불가) |

---

### 4.3 PointKey (포인트 키)

**책임**: 포인트 키를 표현하는 불변 객체

**특징**:
- 불변 객체
- UUID 기반 자동 생성 지원

**주요 기능**:

| 메서드               | 설명              |
|-------------------|-----------------|
| of(value: String) | 정적 팩토리 메서드      |
| generate()        | UUID 기반 키 자동 생성 |

---

## 5. Enum 설계

### 5.1 PointAccumulationStatus (적립 상태)

| 값           | 설명  |
|-------------|-----|
| ACCUMULATED | 적립됨 |
| CANCELLED   | 취소됨 |
| EXPIRED     | 만료됨 |

### 5.2 PointUsageStatus (사용 상태)

| 값                   | 설명     |
|---------------------|--------|
| USED                | 사용됨    |
| PARTIALLY_CANCELLED | 부분 취소됨 |
| FULLY_CANCELLED     | 전체 취소됨 |

### 5.3 CancellationType (취소 유형)

| 값                         | 설명    |
|---------------------------|-------|
| ACCUMULATION_CANCELLATION | 적립 취소 |
| USAGE_CANCELLATION        | 사용 취소 |

---

## 6. 도메인 이벤트 설계

### 6.1 PointBalanceEvent (포인트 잔액 이벤트)

**책임**: 포인트 잔액 변경 사항을 비동기로 전파

**이벤트 유형**:

| 유형          | 설명              |
|-------------|-----------------|
| ACCUMULATED | 포인트 적립됨         |
| USED        | 포인트 사용됨         |
| CANCELLED   | 포인트 취소됨         |
| RESTORED    | 포인트 복원됨 (사용 취소) |
| EXPIRED     | 포인트 만료됨         |

**주요 속성**:
- memberId: 사용자 ID
- eventType: 이벤트 유형
- amount: 변경 금액
- occurredAt: 발생 시간

### 6.2 BalanceReconciliationRequestEvent (잔액 보정 요청 이벤트)

**책임**: 잔액 정합성 보정 요청

**주요 속성**:
- memberId: 사용자 ID
- requestedAt: 요청 시간

---

## 7. 도메인 서비스 설계

### 7.1 PointUsagePriorityService (사용 우선순위 서비스)

**책임**: 포인트 사용 시 적립 건 선택 우선순위 결정

**우선순위 규칙**:
1. **1순위**: 수기 지급 포인트 (isManualGrant = true)
   - 수기 지급 포인트 내에서도 만료일이 짧게 남은 순서로 정렬
2. **2순위**: 일반 적립 포인트 중 만료일이 짧게 남은 순서
   - 만료일이 동일한 경우 적립 시점이 빠른 순서로 사용

**주요 기능**:

| 메서드                              | 설명          |
|----------------------------------|-------------|
| selectAccumulationsForUsage(...) | 사용할 적립 건 선택 |

**비즈니스 규칙**:
- 사용 가능한 적립 건만 필터링
- 만료되지 않은 적립 건만 선택
- 선택된 적립 건의 합계가 사용 금액에 도달할 때까지 선택
- 사용 가능한 포인트가 부족하면 InsufficientPointException 발생

---

## 8. 도메인 예외 설계

### 8.1 예외 계층 구조

```
PointDomainException (기본 도메인 예외)
├── InsufficientPointException (포인트 부족)
├── CannotCancelAccumulationException (적립 취소 불가)
├── CannotCancelUsageException (사용 취소 불가)
├── CannotCancelDetailException (상세 내역 취소 불가)
├── InvalidAmountException (잘못된 금액)
├── InvalidExpirationDateException (잘못된 만료일)
├── MaxBalanceExceededException (최대 보유 금액 초과)
├── MaxAccumulationExceededException (최대 적립 금액 초과)
├── ConfigNotFoundException (설정 정보 없음)
├── InvalidConfigKeyException (잘못된 설정 키)
├── InvalidConfigValueException (잘못된 설정 값)
└── PointExpiredException (포인트 만료됨)
```

### 8.2 주요 예외 설명

| 예외                                | 설명                      |
|-----------------------------------|-------------------------|
| InsufficientPointException        | 사용 가능한 포인트가 부족한 경우      |
| CannotCancelAccumulationException | 이미 사용된 포인트를 적립 취소하려는 경우 |
| CannotCancelUsageException        | 취소할 수 없는 사용 건인 경우       |
| MaxBalanceExceededException       | 개인별 최대 보유 금액을 초과한 경우    |
| MaxAccumulationExceededException  | 1회 최대 적립 금액을 초과한 경우     |
| InvalidExpirationDateException    | 만료일이 유효하지 않은 경우         |
| PointExpiredException             | 만료된 포인트를 사용하려는 경우       |

---

## 9. 아웃바운드 포트 인터페이스

> **참고**: 헥사고날 아키텍처 원칙에 따라, 리포지토리 인터페이스는 Application 레이어의 `application.port.output` 패키지에 정의됩니다.

### 9.1 영속성 포트

| 포트                                | 설명            |
|-----------------------------------|---------------|
| PointAccumulationPersistencePort  | 포인트 적립 영속성    |
| PointUsagePersistencePort         | 포인트 사용 영속성    |
| PointUsageDetailPersistencePort   | 포인트 사용 상세 영속성 |
| MemberPointBalancePersistencePort | 회원 포인트 잔액 영속성 |

### 9.2 설정 포트

| 포트              | 설명        |
|-----------------|-----------|
| PointConfigPort | 포인트 설정 관리 |

### 9.3 이벤트 포트

| 포트                         | 설명            |
|----------------------------|---------------|
| PointBalanceEventPublisher | 포인트 잔액 이벤트 발행 |

---

## 10. 다음 단계

다음 단계에서는 API 설계를 통해 REST 엔드포인트와 DTO를 정의할 예정입니다.

---

**다음 문서**: [04. API 설계](./04-API-설계.md)
