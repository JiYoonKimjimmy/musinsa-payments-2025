# 01. 도메인 분석 및 요구사항 정리

## 1. 개요

무신사페이먼츠 무료 포인트 시스템은 사용자에게 포인트를 적립하고, 사용하며, 취소할 수 있는 기능을 제공하는 백엔드 API 시스템입니다.

## 2. 핵심 비즈니스 규칙

### 2.1 적립 규칙

#### 2.1.1 적립 금액 제한
- **1회 적립 가능 범위**: 1포인트 이상, 10만포인트 이하
- **1회 최대 적립 금액**: 하드코딩이 아닌 동적 설정으로 관리 (기본값: 10만포인트)
- **개인별 최대 보유 금액**: 하드코딩이 아닌 동적 설정으로 관리

#### 2.1.2 포인트 추적
- 특정 시점에 적립된 포인트는 **1포인트 단위까지** 어떤 주문에서 사용되었는지 추적 가능해야 함
- 각 적립 건은 고유한 식별자(pointKey)를 가짐

#### 2.1.3 수기 지급 포인트
- 관리자가 수기로 지급한 포인트는 다른 적립과 구분되어 식별 가능해야 함
- 수기 지급 포인트는 일반 적립 포인트와 별도로 관리

#### 2.1.4 만료일 관리
- 모든 포인트는 만료일을 가짐
- 만료일 범위: 최소 1일 이상, 최대 5년 미만
- 기본 만료일: 365일

### 2.2 적립 취소 규칙

#### 2.2.1 취소 조건
- 특정 적립 행위에서 적립한 금액만큼만 취소 가능
- **중요**: 적립한 금액 중 일부라도 사용된 경우 적립 취소 불가
- 즉, 적립 취소는 전체 금액이 사용되지 않은 상태에서만 가능
- **PointKey 할당**: 적립 취소는 기존 적립 건을 취소하는 것이므로 별도의 PointKey를 할당하지 않음

### 2.3 사용 규칙

#### 2.3.1 사용 조건
- 주문 시에만 포인트 사용 가능
- 주문번호와 함께 포인트 사용 내역 기록

#### 2.3.2 사용 우선순위
포인트 사용 시 다음 우선순위로 사용:
1. **1순위**: 관리자가 수기 지급한 포인트
   - 수기 지급 포인트들 사이에서도 만료일이 짧게 남은 순서로 정렬하여 사용
2. **2순위**: 일반 적립 포인트 중 만료일이 짧게 남은 순서로 사용 (FIFO - First In First Out)
   - 만료일이 동일한 경우 적립 시점이 빠른 순서로 사용

#### 2.3.3 사용 추적
- 포인트 사용 시 주문번호를 함께 기록
- 어떤 주문에서 얼마의 포인트를 사용했는지 식별 가능

### 2.4 사용 취소 규칙

#### 2.4.1 취소 가능 범위
- 사용한 금액 중 전체 또는 일부 사용 취소 가능
- 부분 취소 지원
- **PointKey 할당**: 사용 취소는 새로운 트랜잭션이므로 별도의 PointKey를 할당함
- 동일 사용 건(PointKey)에서 여러 번 부분 취소 가능하며, 각 취소 건은 원래 사용 건과 연결되어 추적됨

#### 2.4.2 만료 포인트 처리
- 사용 취소 시점에 이미 만료된 포인트를 사용 취소해야 하는 경우
- 해당 금액만큼 **신규 적립 처리** 필요
- 새로운 PointKey로 적립 처리
- 만료되지 않은 포인트는 사용 가능 잔액을 복구 처리
- 신규 적립 시 만료일은 기본 만료일(365일)을 적용하여 설정

## 3. 도메인 용어 정의

### 3.1 핵심 용어

| 용어 | 설명 |
|------|------|
| **PointKey** | 포인트 적립/사용/사용취소 건을 식별하는 고유 키 (적립 취소는 기존 적립 건을 취소하므로 별도 PointKey 할당 없음) |
| **적립 (Accumulation)** | 포인트를 사용자에게 지급하는 행위 |
| **적립 취소 (Accumulation Cancellation)** | 적립한 포인트를 취소하는 행위 |
| **사용 (Usage)** | 주문 시 포인트를 차감하는 행위 |
| **사용 취소 (Usage Cancellation)** | 사용한 포인트를 취소하는 행위 |
| **수기 지급 (Manual Grant)** | 관리자가 수기로 지급한 포인트 |
| **만료일 (Expiration Date)** | 포인트가 만료되는 날짜 |
| **사용 가능 잔액 (Available Balance)** | 아직 사용되지 않은 포인트 금액 |
| **총 잔액 (Total Balance)** | 사용자가 보유한 전체 포인트 금액 |

### 3.2 포인트 상태

- **적립됨 (Accumulated)**: 포인트가 적립된 상태
- **사용됨 (Used)**: 포인트가 사용된 상태
- **취소됨 (Cancelled)**: 포인트가 취소된 상태
- **만료됨 (Expired)**: 포인트가 만료된 상태

## 4. 비즈니스 시나리오 분석

### 4.1 시나리오 1: 기본 적립 및 사용

```
1. 1000포인트 적립 (pointKey: A)
   - 총 잔액: 0 → 1000포인트
   - A의 사용 가능 잔액: 1000포인트

2. 500포인트 적립 (pointKey: B)
   - 총 잔액: 1000 → 1500포인트
   - B의 사용 가능 잔액: 500포인트

3. 주문번호 A1234에서 1200포인트 사용 (pointKey: C)
   - 총 잔액: 1500 → 300포인트
   - A에서 1000포인트 사용 → A의 사용 가능 잔액: 1000 → 0포인트
   - B에서 200포인트 사용 → B의 사용 가능 잔액: 500 → 300포인트
```

### 4.2 시나리오 2: 만료 포인트 처리

```
1. A 적립이 만료됨

2. C의 사용금액 1200포인트 중 1100포인트 부분 사용 취소 (pointKey: D)
   - 사용 취소 건에 PointKey D 할당
   - 총 잔액: 300 → 1400포인트
   - 사용 취소 시점 기준으로 A는 만료되었으므로 1000포인트를 신규 적립 처리 (pointKey: E)
     * 신규 적립 시 만료일은 기본 만료일(365일) 적용
   - B는 만료되지 않았으므로 사용 가능 잔액 복구: 300 → 400포인트
   - C의 남은 사용 금액: 100포인트 (동일 사용 건에서 추가 부분 취소 가능)
     * 추가 취소 시에도 별도의 PointKey가 할당됨
```

## 5. 제약사항 및 검증 규칙

### 5.1 적립 시 검증
- [ ] 적립 금액이 1포인트 이상인지 확인
- [ ] 적립 금액이 1회 최대 적립 금액 이하인지 확인
- [ ] 적립 후 총 보유 금액이 개인별 최대 보유 금액을 초과하지 않는지 확인
- [ ] 만료일이 1일 이상, 5년 미만인지 확인

### 5.2 적립 취소 시 검증
- [ ] 해당 적립 건이 존재하는지 확인
- [ ] 해당 적립 건이 이미 취소되지 않았는지 확인
- [ ] 해당 적립 건의 사용 가능 잔액이 전체 적립 금액과 동일한지 확인 (사용된 금액이 없어야 함)

### 5.3 사용 시 검증
- [ ] 사용할 포인트 금액이 사용 가능 잔액 이하인지 확인
- [ ] 주문번호가 제공되었는지 확인
- [ ] 사용 우선순위에 따라 포인트를 선택하는지 확인

### 5.4 사용 취소 시 검증
- [ ] 사용 건이 존재하는지 확인
- [ ] 취소할 금액이 사용된 금액 이하인지 확인
- [ ] 사용 취소 시점 기준으로 만료 여부를 판단하는지 확인
- [ ] 만료된 포인트는 신규 적립 처리하는지 확인
- [ ] 만료되지 않은 포인트는 사용 가능 잔액을 복구하는지 확인
- [ ] 신규 적립 시 만료일이 기본 만료일(365일)로 설정되는지 확인

## 6. 비기능 요구사항

### 6.1 기술 스택
- Java 21
- Spring Boot 3.x
- H2 Database (개발 환경)

### 6.2 아키텍처
- 헥사고날 아키텍처(Hexagonal Architecture) 적용

### 6.3 설정 관리
- 1회 최대 적립 금액: 동적 설정
- 개인별 최대 보유 금액: 동적 설정
- 기본 만료일: 동적 설정 (기본값: 365일)

### 6.4 문서화 요구사항
- **ERD**: PDF 또는 이미지 파일 형식으로 resource 하위에 포함 (필수)
- **AWS 아키텍처 구성도**: AWS 기반 서비스 가정 시 아키텍처 구성을 PDF 또는 이미지 파일 형식으로 resource 하위에 포함 (옵션)
- **README.md**: 빌드 방법과 과제 설명을 README.md 파일에 작성 (필수)

## 7. 도메인 모델 후보

### 7.1 주요 엔티티 후보
- **PointAccumulation**: 포인트 적립 정보
- **PointUsage**: 포인트 사용 정보
- **PointUsageDetail**: 포인트 사용 상세 (1원 단위 추적)
- **Member/User**: 사용자 정보
- **PointConfig**: 포인트 설정 정보

### 7.2 주요 속성 후보
- pointKey: 고유 식별자
- memberId: 사용자 ID
- amount: 금액
- expirationDate: 만료일
- isManualGrant: 수기 지급 여부
- orderNumber: 주문번호
- status: 상태 (적립됨, 사용됨, 취소됨, 만료됨)

## 8. 다음 단계

다음 단계에서는 ERD 설계를 통해 데이터베이스 구조를 구체화할 예정입니다.

---

**다음 문서**: [02. ERD 설계](./02-ERD-설계.md)

