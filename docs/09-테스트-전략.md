# 09. 테스트 전략

## 1. 개요

무료 포인트 시스템의 테스트 전략입니다. 단위 테스트, 통합 테스트, API 테스트를 포함한 포괄적인 테스트 계획을 수립합니다.

## 2. 테스트 피라미드

### 2.1 테스트 계층 구조

```
        ┌─────────────┐
        │   E2E Test  │     (소수)
        │  (API Test) │
        └─────────────┘
       ┌────────────────┐
       │   Integration  │   (중간)
       │      Test      │
       └────────────────┘
      ┌──────────────────┐
      │    Unit Test     │  (다수)
      │                  │
      └──────────────────┘
```

### 2.2 테스트 비율 및 목표

| 테스트 유형       | 비율  | 커버리지 목표 |
|--------------|-----|---------|
| Unit Test    | 70% | 90% 이상  |
| Integration  | 20% | 80% 이상  |
| E2E/API Test | 10% | 핵심 시나리오 |

---

## 3. 테스트 디렉토리 구조

### 3.1 테스트 코드 구조

```
src/test/kotlin/com/musinsa/payments/point/
├── application/
│   ├── event/                          # 이벤트 핸들러 테스트
│   │   ├── BalanceReconciliationEventHandlerTest.kt
│   │   └── PointBalanceEventHandlerTest.kt
│   ├── integration/                    # 시나리오 통합 테스트
│   │   ├── ScenarioAccumulationAndUsageTest.kt
│   │   └── ScenarioExpiredPointHandlingTest.kt
│   └── service/                        # 서비스 단위 테스트
│       ├── PointAccumulationServiceTest.kt
│       ├── PointUsageServiceTest.kt
│       ├── PointUsageServiceConcurrencyTest.kt
│       ├── PointCancellationServiceTest.kt
│       ├── PointQueryServiceTest.kt
│       ├── PointConfigServiceTest.kt
│       ├── PointConfigValidatorTest.kt
│       ├── PointBalanceCacheUpdateServiceTest.kt
│       └── PointBalanceReconciliationServiceTest.kt
├── domain/
│   ├── entity/                         # 엔티티 단위 테스트
│   │   ├── PointAccumulationTest.kt
│   │   ├── PointUsageTest.kt
│   │   ├── PointUsageDetailTest.kt
│   │   ├── PointConfigTest.kt
│   │   └── MemberPointBalanceTest.kt
│   ├── event/                          # 도메인 이벤트 테스트
│   │   └── PointBalanceEventTest.kt
│   ├── service/                        # 도메인 서비스 테스트
│   │   └── PointUsagePriorityServiceTest.kt
│   └── valueobject/                    # 값 객체 테스트
│       ├── MoneyTest.kt
│       ├── OrderNumberTest.kt
│       └── PointKeyTest.kt
├── infrastructure/
│   ├── config/                         # 설정 어댑터 테스트
│   │   ├── DataInitializerTest.kt
│   │   ├── PointConfigAdapterTest.kt
│   │   └── PointConfigHistoryAdapterTest.kt
│   └── persistence/                    # 영속성 어댑터 테스트
│       ├── adapter/
│       │   ├── PointAccumulationPersistenceAdapterTest.kt
│       │   ├── PointUsagePersistenceAdapterTest.kt
│       │   └── PointUsageDetailPersistenceAdapterTest.kt
│       └── jpa/repository/
│           ├── PointAccumulationJpaRepositoryTest.kt
│           ├── PointUsageJpaRepositoryTest.kt
│           ├── PointUsageDetailJpaRepositoryTest.kt
│           └── PointConfigJpaRepositoryTest.kt
└── presentation/web/
    ├── controller/                     # 컨트롤러 테스트
    │   ├── PointAccumulationControllerTest.kt
    │   ├── PointUsageControllerTest.kt
    │   ├── PointCancellationControllerTest.kt
    │   ├── PointQueryControllerTest.kt
    │   └── PointConfigControllerTest.kt
    └── exception/
        └── GlobalExceptionHandlerTest.kt
```

### 3.2 테스트 픽스처 구조

```
src/testFixtures/kotlin/com/musinsa/payments/point/
├── application/port/output/
│   ├── config/fixtures/
│   │   ├── FakePointConfigPort.kt
│   │   └── FakePointConfigHistoryPort.kt
│   ├── event/fixtures/
│   │   ├── FakePointBalanceEventPublisher.kt
│   │   ├── EventCapturingPublisher.kt
│   │   └── NoOpEventPublisher.kt
│   ├── persistence/fixtures/
│   │   ├── FakePointAccumulationPersistencePort.kt
│   │   ├── FakePointUsagePersistencePort.kt
│   │   ├── FakePointUsageDetailPersistencePort.kt
│   │   └── FakeMemberPointBalancePersistencePort.kt
│   └── fixtures/
│       └── FakePointKeyGenerator.kt
├── domain/entity/fixtures/
│   ├── PointAccumulationFixture.kt
│   ├── PointUsageFixture.kt
│   └── PointUsageDetailFixture.kt
└── test/
    └── TestDataGenerator.kt
```

---

## 4. 테스트 유형별 전략

### 4.1 단위 테스트 (Unit Test)

| 대상         | 테스트 방식            | 도구            |
|------------|-------------------|---------------|
| 도메인 엔티티    | 비즈니스 규칙 검증        | Kotest        |
| 값 객체       | 불변성, 동등성 검증       | Kotest        |
| 도메인 서비스    | 순수 로직 검증          | Kotest        |
| 애플리케이션 서비스 | Fake 포트 활용 단위 테스트 | Kotest + Fake |

**Fake 구현체 활용**:
- `FakePointAccumulationPersistencePort`: 메모리 기반 적립 저장소
- `FakePointUsagePersistencePort`: 메모리 기반 사용 저장소
- `FakePointBalanceEventPublisher`: 이벤트 발행 검증용

### 4.2 통합 테스트 (Integration Test)

| 대상       | 테스트 방식                  | 도구                      |
|----------|-------------------------|-------------------------|
| 영속성 어댑터  | JPA Repository + DB 검증  | @DataJpaTest + H2       |
| 설정 어댑터   | 설정 저장/조회 검증             | @DataJpaTest            |
| 시나리오 테스트 | 전체 흐름 검증                | @SpringBootTest + Fake  |

### 4.3 API 테스트 (E2E Test)

| 대상       | 테스트 방식        | 도구               |
|----------|---------------|------------------|
| REST API | HTTP 요청/응답 검증 | MockMvc + Kotest |
| 예외 핸들러   | 에러 응답 형식 검증   | MockMvc          |

---

## 5. 시나리오 테스트

### 5.1 구현된 시나리오

| 시나리오                             | 파일명                                  | 설명                        |
|----------------------------------|--------------------------------------|---------------------------|
| 기본 적립 및 사용                       | ScenarioAccumulationAndUsageTest.kt  | 적립 → 사용 → 잔액 검증           |
| 만료 포인트 처리                        | ScenarioExpiredPointHandlingTest.kt  | 만료 포인트 사용 취소 시 신규 적립 검증   |

### 5.2 시나리오 테스트 검증 항목

**시나리오 1: 기본 적립 및 사용**

| 단계 | 행위         | 검증 항목                   |
|----|------------|-------------------------|
| 1  | 1000포인트 적립 | 잔액 1000, 상태 ACCUMULATED |
| 2  | 500포인트 적립  | 잔액 1500                 |
| 3  | 1200포인트 사용 | 잔액 300, 사용 우선순위 검증      |

**시나리오 2: 만료 포인트 처리**

| 단계 | 행위         | 검증 항목                     |
|----|------------|---------------------------|
| 1  | 포인트 적립/사용  | 정상 처리                     |
| 2  | 적립 건 만료 처리 | isExpired() = true        |
| 3  | 사용 취소      | 만료 포인트는 신규 적립, 미만료는 잔액 복원 |

---

## 6. 테스트 도구

### 6.1 주요 테스트 라이브러리

| 라이브러리             | 용도               | 특징                        |
|-------------------|------------------|---------------------------|
| Kotest            | 테스트 프레임워크        | String/Behavior Spec 지원   |
| MockK             | 모킹 라이브러리         | Kotlin 전용, 코루틴 지원         |
| Spring Test       | Spring 통합 테스트    | @SpringBootTest, MockMvc  |
| H2 Database       | 테스트 DB           | 인메모리 데이터베이스               |

### 6.2 Kotest 스타일 가이드

| 스타일          | 사용 케이스      | 예시                   |
|--------------|-------------|----------------------|
| StringSpec   | 간단한 단위 테스트  | 값 객체, 엔티티 메서드 검증     |
| BehaviorSpec | BDD 스타일 테스트 | Given-When-Then 시나리오 |
| FunSpec      | 함수형 테스트     | 유틸리티 함수 검증           |

---

## 7. 테스트 커버리지

### 7.1 커버리지 목표

| 영역             | 라인 커버리지 | 브랜치 커버리지 |
|----------------|---------|----------|
| Domain         | 90% 이상  | 85% 이상   |
| Application    | 80% 이상  | 75% 이상   |
| Infrastructure | 70% 이상  | 65% 이상   |
| Presentation   | 70% 이상  | 65% 이상   |

### 7.2 커버리지 도구

| 도구     | 용도          | 리포트 위치                            |
|--------|-------------|-----------------------------------|
| JaCoCo | 코드 커버리지 측정  | `build/reports/jacoco/test/html/` |
| Gradle | 커버리지 리포트 생성 | `./gradlew test jacocoTestReport` |

---

## 8. 테스트 실행

### 8.1 실행 명령어

| 명령어                                      | 설명           |
|------------------------------------------|--------------|
| `./gradlew test`                         | 전체 테스트 실행    |
| `./gradlew test --tests "*ServiceTest"`  | 서비스 테스트만 실행  |
| `./gradlew test jacocoTestReport`        | 커버리지 리포트 생성  |

### 8.2 테스트 격리

| 방식              | 용도       | 적용 대상      |
|-----------------|----------|------------|
| @Transactional  | 테스트 후 롤백 | 통합 테스트     |
| Fake 구현체        | 의존성 격리   | 서비스 단위 테스트 |
| @DirtiesContext | 컨텍스트 재생성 | 상태 변경 테스트  |

---

## 9. 성능 테스트

### 9.1 성능 목표

| 지표     | 목표값        | 설명           |
|--------|------------|--------------|
| TPS    | 1,000 이상   | 초당 트랜잭션 처리량  |
| P50 응답 | 100ms 이하   | 평균 응답 시간     |
| P95 응답 | 300ms 이하   | 95% 응답 시간    |
| 에러율    | 0.1% 이하    | HTTP 5xx 비율  |

### 9.2 부하 테스트 도구

| 도구      | 특징               | 사용 시점     |
|---------|------------------|-----------|
| k6      | 경량, 스크립트 기반      | 일반 부하 테스트 |
| JMeter  | GUI, 대규모 테스트     | 스트레스 테스트  |
| Gatling | Scala 기반, 상세 리포트 | 고급 시나리오   |

---

## 10. CI/CD 통합

### 10.1 자동화 테스트

| 트리거     | 실행 테스트             | 통과 조건      |
|---------|--------------------|------------|
| PR 생성   | Unit + Integration | 전체 통과      |
| Merge   | 전체 테스트 + 커버리지      | 커버리지 기준 충족 |
| Release | E2E + 성능 테스트 (선택)  | 성능 기준 충족   |

### 10.2 커버리지 게이트

| 조건         | 기준값    |
|------------|--------|
| 전체 라인 커버리지 | 80% 이상 |
| 신규 코드 커버리지 | 80% 이상 |
| 브랜치 커버리지   | 75% 이상 |

---

## 11. 다음 단계

다음 단계에서는 문서화 계획을 수립하여 프로젝트의 빌드 방법과 사용법을 정리할 예정입니다.

---

**다음 문서**: [10. 문서화 계획](./10-문서화-계획.md)
