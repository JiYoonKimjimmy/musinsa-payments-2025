# 09. 테스트 전략

## 1. 개요

무료 포인트 시스템의 테스트 전략을 설계합니다. 단위 테스트, 통합 테스트, API 테스트를 포함한 포괄적인 테스트 계획을 수립합니다.

## 2. 테스트 피라미드

### 2.1 테스트 계층 구조

```
        ┌─────────────┐
        │   E2E Test   │  (소수)
        │  (API Test)  │
        └─────────────┘
       ┌───────────────┐
       │ Integration   │  (중간)
       │     Test      │
       └───────────────┘
     ┌─────────────────┐
     │   Unit Test     │  (다수)
     │                 │
     └─────────────────┘
```

### 2.2 테스트 비율

- **Unit Test**: 70%
- **Integration Test**: 20%
- **E2E/API Test**: 10%

## 3. 단위 테스트 (Unit Test)

### 3.1 테스트 대상

#### 3.1.1 도메인 엔티티

**테스트 파일 위치**:
```
src/test/kotlin/com/musinsa/payments/point/domain/entity/
```

**테스트 대상**:
- `PointAccumulationTest.kt`
- `PointUsageTest.kt`
- `PointUsageDetailTest.kt`

**테스트 케이스 예시** (Kotest String Spec 스타일):

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.kotest.matchers.types.shouldBeInstanceOf
import io.kotest.assertions.throwables.shouldThrow

class PointAccumulationTest : StringSpec({
    
    "사용되지 않은 적립은 취소 가능해야 한다" {
        // given
        val accumulation = PointAccumulation().apply {
            amount = Money.of(1000)
            availableAmount = Money.of(1000)
            status = PointAccumulationStatus.ACCUMULATED
        }
        
        // when
        val result = accumulation.canBeCancelled()
        
        // then
        result shouldBe true
    }
    
    "일부 사용된 적립은 취소 불가해야 한다" {
        // given
        val accumulation = PointAccumulation().apply {
            amount = Money.of(1000)
            availableAmount = Money.of(500)
            status = PointAccumulationStatus.ACCUMULATED
        }
        
        // when
        val result = accumulation.canBeCancelled()
        
        // then
        result shouldBe false
    }
    
    "포인트 사용 시 사용 가능 잔액이 차감되어야 한다" {
        // given
        val accumulation = PointAccumulation().apply {
            amount = Money.of(1000)
            availableAmount = Money.of(1000)
        }
        val usageAmount = Money.of(300)
        
        // when
        accumulation.use(usageAmount)
        
        // then
        accumulation.availableAmount shouldBe Money.of(700)
    }
    
    "사용 가능 잔액이 부족하면 예외가 발생해야 한다" {
        // given
        val accumulation = PointAccumulation().apply {
            amount = Money.of(1000)
            availableAmount = Money.of(500)
        }
        val usageAmount = Money.of(600)
        
        // when & then
        val exception = shouldThrow<InsufficientPointException> {
            accumulation.use(usageAmount)
        }
        exception.shouldBeInstanceOf<InsufficientPointException>()
    }
    
    "만료일이 지난 경우 만료 여부가 true여야 한다" {
        // given
        val accumulation = PointAccumulation().apply {
            expirationDate = LocalDate.now().minusDays(1)
        }
        
        // when
        val result = accumulation.isExpired()
        
        // then
        result shouldBe true
    }
})
```

#### 3.1.2 값 객체

**테스트 파일 위치**:
```
src/test/kotlin/com/musinsa/payments/point/domain/valueobject/
```

**테스트 대상**:
- `MoneyTest.kt`
- `OrderNumberTest.kt`
- `PointKeyTest.kt`

**테스트 케이스 예시** (Kotest String Spec 스타일):

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.kotest.assertions.throwables.shouldThrow

class MoneyTest : StringSpec({
    
    "금액 덧셈이 정상적으로 동작해야 한다" {
        // given
        val money1 = Money.of(1000)
        val money2 = Money.of(500)
        
        // when
        val result = money1.add(money2)
        
        // then
        result.toLong() shouldBe 1500L
    }
    
    "금액 뺄셈이 정상적으로 동작해야 한다" {
        // given
        val money1 = Money.of(1000)
        val money2 = Money.of(300)
        
        // when
        val result = money1.subtract(money2)
        
        // then
        result.toLong() shouldBe 700L
    }
    
    "음수 금액 생성 시 예외가 발생해야 한다" {
        // when & then
        shouldThrow<IllegalArgumentException> {
            Money.of(-100)
        }
    }
})
```

#### 3.1.3 도메인 서비스

**테스트 파일 위치**:
```
src/test/kotlin/com/musinsa/payments/point/domain/service/
```

**테스트 대상**:
- `PointUsagePriorityServiceTest.kt`

**테스트 케이스 예시** (Kotest String Spec 스타일):

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.kotest.matchers.collections.shouldHaveSize
import io.kotest.matchers.comparables.shouldBeLessThan

class PointUsagePriorityServiceTest : StringSpec({
    
    val service = PointUsagePriorityService()
    
    "수기 지급 포인트가 우선 사용되어야 한다" {
        // given
        val manualGrant = PointAccumulation().apply {
            id = 1L
            amount = Money.of(1000)
            availableAmount = Money.of(1000)
            isManualGrant = true
            expirationDate = LocalDate.now().plusDays(365)
        }
        
        val normal = PointAccumulation().apply {
            id = 2L
            amount = Money.of(500)
            availableAmount = Money.of(500)
            isManualGrant = false
            expirationDate = LocalDate.now().plusDays(100)
        }
        
        val accumulations = listOf(normal, manualGrant)
        val usageAmount = Money.of(1200)
        
        // when
        val selected = service
            .selectAccumulationsForUsage(1L, usageAmount, accumulations)
        
        // then
        selected shouldHaveSize 2
        selected[0].isManualGrant() shouldBe true  // 수기 지급이 먼저
    }
    
    "만료일이 짧은 포인트가 우선 사용되어야 한다" {
        // given
        val longExpiration = PointAccumulation().apply {
            id = 1L
            amount = Money.of(1000)
            availableAmount = Money.of(1000)
            isManualGrant = false
            expirationDate = LocalDate.now().plusDays(365)
        }
        
        val shortExpiration = PointAccumulation().apply {
            id = 2L
            amount = Money.of(500)
            availableAmount = Money.of(500)
            isManualGrant = false
            expirationDate = LocalDate.now().plusDays(100)
        }
        
        val accumulations = listOf(longExpiration, shortExpiration)
        val usageAmount = Money.of(1200)
        
        // when
        val selected = service
            .selectAccumulationsForUsage(1L, usageAmount, accumulations)
        
        // then
        selected shouldHaveSize 2
        selected[0].expirationDate shouldBeLessThan selected[1].expirationDate
    }
})
```

### 3.2 테스트 도구

- **Kotest**: Kotlin 전용 테스트 프레임워크
  - 다양한 테스트 스타일 지원 (String Spec, Behavior Spec, Fun Spec 등)
  - 내장 어설션 라이브러리
  - Kotlin DSL 기반의 직관적인 테스트 작성
- **MockK**: Kotlin 전용 모킹 라이브러리
  - Kotest와 완벽한 통합
  - 코루틴 지원

## 4. 통합 테스트 (Integration Test)

### 4.1 테스트 대상

#### 4.1.1 리포지토리 통합 테스트

**테스트 파일 위치**:
```
src/test/kotlin/com/musinsa/payments/point/adapter/out/persistence/
```

**테스트 케이스 예시** (Kotest + Spring Extension):

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.extensions.spring.SpringExtension
import io.kotest.matchers.nulls.shouldNotBeNull
import io.kotest.matchers.shouldBe
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest

@DataJpaTest
class PointAccumulationPersistenceAdapterTest(
    @Autowired val jpaRepository: JpaPointAccumulationRepository
) : StringSpec({
    
    extension(SpringExtension)
    
    lateinit var adapter: PointAccumulationPersistenceAdapter
    lateinit var mapper: PointEntityMapper
    
    beforeSpec {
        mapper = PointEntityMapper()
        adapter = PointAccumulationPersistenceAdapter(jpaRepository, mapper)
    }
    
    "포인트 적립 저장 및 조회가 정상적으로 동작해야 한다" {
        // given
        val accumulation = PointAccumulation().apply {
            pointKey = "A"
            memberId = 1L
            amount = Money.of(1000)
            availableAmount = Money.of(1000)
            expirationDate = LocalDate.now().plusDays(365)
            isManualGrant = false
            status = PointAccumulationStatus.ACCUMULATED
        }
        
        // when
        val saved = adapter.save(accumulation)
        val found = adapter.findByPointKey("A")
        
        // then
        found shouldNotBeNull
        found?.amount shouldBe Money.of(1000)
    }
})
```

#### 4.1.2 서비스 통합 테스트

**테스트 파일 위치**:
```
src/test/kotlin/com/musinsa/payments/point/service/
```

**테스트 케이스 예시** (Kotest + Spring Extension):

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.extensions.spring.SpringExtension
import io.kotest.matchers.nulls.shouldNotBeNull
import io.kotest.matchers.shouldBe
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.transaction.annotation.Transactional

@SpringBootTest
@Transactional
class PointAccumulationServiceIntegrationTest(
    @Autowired val service: PointAccumulationService,
    @Autowired val configRepository: PointConfigRepository
) : StringSpec({
    
    extension(SpringExtension)
    
    "포인트 적립 전체 플로우가 정상적으로 동작해야 한다" {
        // given
        val request = AccumulatePointRequest(
            memberId = 1L,
            amount = 1000L,
            expirationDays = 365,
            isManualGrant = false
        )
        
        // when
        val response = service.accumulate(request)
        
        // then
        response.pointKey shouldNotBeNull
        response.amount shouldBe 1000L
        response.availableAmount shouldBe 1000L
    }
})
```

### 4.2 테스트 데이터베이스

- **H2 Database**: 인메모리 데이터베이스 사용
- **Testcontainers**: Docker 기반 통합 테스트 (옵션)

### 4.3 테스트 설정

**application-test.yml**:
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
  h2:
    console:
      enabled: true
```

## 5. API 테스트 (E2E Test)

### 5.1 테스트 대상

#### 5.1.1 REST API 테스트

**테스트 파일 위치**:
```
src/test/kotlin/com/musinsa/payments/point/adapter/in/web/
```

**테스트 케이스 예시** (Kotest + Spring Extension + MockMvc):

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.extensions.spring.SpringExtension
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.http.MediaType
import org.springframework.test.web.servlet.MockMvc
import org.springframework.test.web.servlet.post
import com.fasterxml.jackson.databind.ObjectMapper

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
class PointAccumulationControllerTest(
    @Autowired val mockMvc: MockMvc,
    @Autowired val objectMapper: ObjectMapper
) : StringSpec({
    
    extension(SpringExtension)
    
    "포인트 적립 API 호출이 성공해야 한다" {
        // given
        val request = AccumulatePointRequest(
            memberId = 1L,
            amount = 1000L,
            expirationDays = 365,
            isManualGrant = false
        )
        
        // when & then
        mockMvc.post("/api/points/accumulate") {
            contentType = MediaType.APPLICATION_JSON
            content = objectMapper.writeValueAsString(request)
        }.andExpect {
            status { isOk() }
            jsonPath("$.success") { value(true) }
            jsonPath("$.data.amount") { value(1000) }
        }
    }
    
    "유효하지 않은 금액으로 포인트 적립 API 호출 시 BadRequest가 반환되어야 한다" {
        // given
        val request = AccumulatePointRequest(
            memberId = 1L,
            amount = 0L  // 유효하지 않은 금액
        )
        
        // when & then
        mockMvc.post("/api/points/accumulate") {
            contentType = MediaType.APPLICATION_JSON
            content = objectMapper.writeValueAsString(request)
        }.andExpect {
            status { isBadRequest() }
        }
    }
})
```

### 5.2 테스트 도구

- **Kotest Spring Extension**: Spring Boot 통합 테스트 지원
- **MockMvc**: Spring MVC 테스트 (Kotest DSL 지원)
- **RestAssured**: REST API 테스트 (옵션)
- **WireMock**: 외부 API 모킹 (옵션)

## 6. 예시 시나리오 기반 테스트

### 6.1 시나리오 1: 기본 적립 및 사용

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.extensions.spring.SpringExtension
import io.kotest.matchers.shouldBe
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.transaction.annotation.Transactional

@SpringBootTest
@Transactional
class Scenario1Test(
    @Autowired val accumulationService: PointAccumulationService,
    @Autowired val usageService: PointUsageService
) : StringSpec({
    
    extension(SpringExtension)
    
    "시나리오 1: 기본 적립 및 사용이 정상적으로 동작해야 한다" {
        // 1. 1000원 적립 (pointKey: A)
        val request1 = AccumulatePointRequest(
            memberId = 1L,
            amount = 1000L
        )
        val response1 = accumulationService.accumulate(request1)
        val pointKeyA = response1.pointKey
        
        // 검증: 총 잔액 1000원
        response1.amount shouldBe 1000L
        response1.availableAmount shouldBe 1000L
        
        // 2. 500원 적립 (pointKey: B)
        val request2 = AccumulatePointRequest(
            memberId = 1L,
            amount = 500L
        )
        val response2 = accumulationService.accumulate(request2)
        val pointKeyB = response2.pointKey
        
        // 검증: 총 잔액 1500원
        // ...
        
        // 3. 주문번호 A1234에서 1200원 사용 (pointKey: C)
        val request3 = UsePointRequest(
            memberId = 1L,
            orderNumber = "A1234",
            amount = 1200L
        )
        val response3 = usageService.use(request3)
        
        // 검증: 총 잔액 300원
        // 검증: A에서 1000원 사용, B에서 200원 사용
        // ...
    }
})
```

### 6.2 시나리오 2: 만료 포인트 처리

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.extensions.spring.SpringExtension
import io.kotest.matchers.shouldBe
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.transaction.annotation.Transactional

@SpringBootTest
@Transactional
class Scenario2Test(
    @Autowired val cancellationService: PointCancellationService
) : StringSpec({
    
    extension(SpringExtension)
    
    "시나리오 2: 만료 포인트 사용 취소가 정상적으로 동작해야 한다" {
        // 1. 포인트 적립 및 사용
        // ...
        
        // 2. A 적립 만료 처리 (시간 조작 또는 직접 만료일 설정)
        // ...
        
        // 3. 사용 취소 (1100원)
        val request = CancelUsageRequest(
            amount = 1100L,
            reason = "주문 취소"
        )
        val response = cancellationService.cancelUsage(pointKeyC, request)
        
        // 검증: 총 잔액 1400원
        // 검증: A는 만료되었으므로 신규 적립 처리 (pointKey: E, 1000원)
        // 검증: B는 만료되지 않았으므로 사용 가능 잔액 복원 (300 → 400원)
        // ...
    }
})
```

## 7. 테스트 커버리지

### 7.1 커버리지 목표

- **라인 커버리지**: 80% 이상
- **브랜치 커버리지**: 75% 이상
- **도메인 로직**: 90% 이상

### 7.2 커버리지 도구

- **JaCoCo**: 코드 커버리지 측정
- **Gradle/Maven 플러그인**: 빌드 시 커버리지 리포트 생성

### 7.3 커버리지 리포트

빌드 후 다음 위치에서 확인:
```
build/reports/jacoco/test/html/index.html
```

## 8. 테스트 실행

### 8.1 로컬 실행

```bash
# 모든 테스트 실행
./gradlew test

# 특정 테스트 클래스 실행
./gradlew test --tests "PointAccumulationTest"

# 커버리지 리포트 생성
./gradlew test jacocoTestReport
```

### 8.2 CI/CD 통합

- **GitHub Actions**: PR 생성 시 자동 테스트 실행
- **코드 커버리지**: PR 코멘트로 커버리지 리포트 표시

## 9. 테스트 데이터 관리

### 9.1 테스트 픽스처

- **@Sql**: SQL 스크립트로 테스트 데이터 준비
- **Test Fixture Builder**: 빌더 패턴으로 테스트 데이터 생성

### 9.2 테스트 격리

- **@Transactional**: 각 테스트 후 롤백 (Kotest Spring Extension과 함께 사용)
- **@DirtiesContext**: 컨텍스트 재생성 (필요 시)
- **Kotest Isolation Mode**: 테스트 간 격리 설정

## 10. 다음 단계

다음 단계에서는 문서화 계획을 수립하여 프로젝트의 빌드 방법과 사용법을 정리할 예정입니다.

---

**다음 문서**: [10. 문서화 계획](./10-문서화-계획.md)

