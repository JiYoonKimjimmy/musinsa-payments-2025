# 09. 테스트 전략

## 1. 개요

무료 포인트 시스템의 테스트 전략을 설계합니다. 단위 테스트, 통합 테스트, API 테스트를 포함한 포괄적인 테스트 계획을 수립합니다.

## 2. 테스트 피라미드

### 2.1 테스트 계층 구조

```
        ┌─────────────┐
        │   E2E Test   │  (소수)
        │  (API Test)  │
        └─────────────┘
       ┌───────────────┐
       │ Integration   │  (중간)
       │     Test      │
       └───────────────┘
     ┌─────────────────┐
     │   Unit Test     │  (다수)
     │                 │
     └─────────────────┘
```

### 2.2 테스트 비율

- **Unit Test**: 70%
- **Integration Test**: 20%
- **E2E/API Test**: 10%

## 3. 단위 테스트 (Unit Test)

### 3.1 테스트 대상

#### 3.1.1 도메인 엔티티

**테스트 파일 위치**:
```
src/test/java/com/musinsa/payments/point/domain/entity/
```

**테스트 대상**:
- `PointAccumulationTest.java`
- `PointUsageTest.java`
- `PointUsageDetailTest.java`

**테스트 케이스 예시**:

```java
@DisplayName("포인트 적립 테스트")
class PointAccumulationTest {
    
    @Test
    @DisplayName("적립 취소 가능 여부 확인 - 사용되지 않은 적립은 취소 가능")
    void canBeCancelled_whenNotUsed_returnsTrue() {
        // given
        PointAccumulation accumulation = PointAccumulation.builder()
            .amount(Money.of(1000))
            .availableAmount(Money.of(1000))
            .status(PointAccumulationStatus.ACCUMULATED)
            .build();
        
        // when
        boolean result = accumulation.canBeCancelled();
        
        // then
        assertThat(result).isTrue();
    }
    
    @Test
    @DisplayName("적립 취소 가능 여부 확인 - 일부 사용된 적립은 취소 불가")
    void canBeCancelled_whenPartiallyUsed_returnsFalse() {
        // given
        PointAccumulation accumulation = PointAccumulation.builder()
            .amount(Money.of(1000))
            .availableAmount(Money.of(500))
            .status(PointAccumulationStatus.ACCUMULATED)
            .build();
        
        // when
        boolean result = accumulation.canBeCancelled();
        
        // then
        assertThat(result).isFalse();
    }
    
    @Test
    @DisplayName("포인트 사용 - 사용 가능 잔액 차감")
    void use_decreasesAvailableAmount() {
        // given
        PointAccumulation accumulation = PointAccumulation.builder()
            .amount(Money.of(1000))
            .availableAmount(Money.of(1000))
            .build();
        Money usageAmount = Money.of(300);
        
        // when
        accumulation.use(usageAmount);
        
        // then
        assertThat(accumulation.getAvailableAmount()).isEqualTo(Money.of(700));
    }
    
    @Test
    @DisplayName("포인트 사용 - 사용 가능 잔액 부족 시 예외 발생")
    void use_whenInsufficientAmount_throwsException() {
        // given
        PointAccumulation accumulation = PointAccumulation.builder()
            .amount(Money.of(1000))
            .availableAmount(Money.of(500))
            .build();
        Money usageAmount = Money.of(600);
        
        // when & then
        assertThatThrownBy(() -> accumulation.use(usageAmount))
            .isInstanceOf(InsufficientPointException.class);
    }
    
    @Test
    @DisplayName("만료 여부 확인 - 만료일이 지난 경우 true")
    void isExpired_whenExpirationDatePassed_returnsTrue() {
        // given
        PointAccumulation accumulation = PointAccumulation.builder()
            .expirationDate(LocalDate.now().minusDays(1))
            .build();
        
        // when
        boolean result = accumulation.isExpired();
        
        // then
        assertThat(result).isTrue();
    }
}
```

#### 3.1.2 값 객체

**테스트 파일 위치**:
```
src/test/java/com/musinsa/payments/point/domain/valueobject/
```

**테스트 대상**:
- `MoneyTest.java`
- `OrderNumberTest.java`
- `PointKeyTest.java`

**테스트 케이스 예시**:

```java
@DisplayName("금액 값 객체 테스트")
class MoneyTest {
    
    @Test
    @DisplayName("금액 덧셈")
    void add_returnsSum() {
        // given
        Money money1 = Money.of(1000);
        Money money2 = Money.of(500);
        
        // when
        Money result = money1.add(money2);
        
        // then
        assertThat(result.toLong()).isEqualTo(1500L);
    }
    
    @Test
    @DisplayName("금액 뺄셈")
    void subtract_returnsDifference() {
        // given
        Money money1 = Money.of(1000);
        Money money2 = Money.of(300);
        
        // when
        Money result = money1.subtract(money2);
        
        // then
        assertThat(result.toLong()).isEqualTo(700L);
    }
    
    @Test
    @DisplayName("음수 금액 생성 시 예외 발생")
    void of_whenNegativeAmount_throwsException() {
        // when & then
        assertThatThrownBy(() -> Money.of(-100))
            .isInstanceOf(IllegalArgumentException.class);
    }
}
```

#### 3.1.3 도메인 서비스

**테스트 파일 위치**:
```
src/test/java/com/musinsa/payments/point/domain/service/
```

**테스트 대상**:
- `PointUsagePriorityServiceTest.java`

**테스트 케이스 예시**:

```java
@DisplayName("포인트 사용 우선순위 서비스 테스트")
class PointUsagePriorityServiceTest {
    
    private PointUsagePriorityService service;
    
    @BeforeEach
    void setUp() {
        service = new PointUsagePriorityService();
    }
    
    @Test
    @DisplayName("수기 지급 포인트가 우선 사용됨")
    void selectAccumulationsForUsage_manualGrantFirst() {
        // given
        PointAccumulation manualGrant = PointAccumulation.builder()
            .id(1L)
            .amount(Money.of(1000))
            .availableAmount(Money.of(1000))
            .isManualGrant(true)
            .expirationDate(LocalDate.now().plusDays(365))
            .build();
        
        PointAccumulation normal = PointAccumulation.builder()
            .id(2L)
            .amount(Money.of(500))
            .availableAmount(Money.of(500))
            .isManualGrant(false)
            .expirationDate(LocalDate.now().plusDays(100))
            .build();
        
        List<PointAccumulation> accumulations = List.of(normal, manualGrant);
        Money usageAmount = Money.of(1200);
        
        // when
        List<PointAccumulation> selected = service
            .selectAccumulationsForUsage(1L, usageAmount, accumulations);
        
        // then
        assertThat(selected).hasSize(2);
        assertThat(selected.get(0).isManualGrant()).isTrue();  // 수기 지급이 먼저
    }
    
    @Test
    @DisplayName("만료일이 짧은 포인트가 우선 사용됨")
    void selectAccumulationsForUsage_expirationDateAscending() {
        // given
        PointAccumulation longExpiration = PointAccumulation.builder()
            .id(1L)
            .amount(Money.of(1000))
            .availableAmount(Money.of(1000))
            .isManualGrant(false)
            .expirationDate(LocalDate.now().plusDays(365))
            .build();
        
        PointAccumulation shortExpiration = PointAccumulation.builder()
            .id(2L)
            .amount(Money.of(500))
            .availableAmount(Money.of(500))
            .isManualGrant(false)
            .expirationDate(LocalDate.now().plusDays(100))
            .build();
        
        List<PointAccumulation> accumulations = List.of(longExpiration, shortExpiration);
        Money usageAmount = Money.of(1200);
        
        // when
        List<PointAccumulation> selected = service
            .selectAccumulationsForUsage(1L, usageAmount, accumulations);
        
        // then
        assertThat(selected).hasSize(2);
        assertThat(selected.get(0).getExpirationDate())
            .isBefore(selected.get(1).getExpirationDate());
    }
}
```

### 3.2 테스트 도구

- **JUnit 5**: 테스트 프레임워크
- **AssertJ**: 어설션 라이브러리
- **Mockito**: 모킹 프레임워크

## 4. 통합 테스트 (Integration Test)

### 4.1 테스트 대상

#### 4.1.1 리포지토리 통합 테스트

**테스트 파일 위치**:
```
src/test/java/com/musinsa/payments/point/adapter/out/persistence/
```

**테스트 케이스 예시**:

```java
@DataJpaTest
@DisplayName("포인트 적립 리포지토리 통합 테스트")
class PointAccumulationPersistenceAdapterTest {
    
    @Autowired
    private JpaPointAccumulationRepository jpaRepository;
    
    private PointAccumulationPersistenceAdapter adapter;
    private PointEntityMapper mapper;
    
    @BeforeEach
    void setUp() {
        mapper = new PointEntityMapper();
        adapter = new PointAccumulationPersistenceAdapter(jpaRepository, mapper);
    }
    
    @Test
    @DisplayName("포인트 적립 저장 및 조회")
    void saveAndFind() {
        // given
        PointAccumulation accumulation = PointAccumulation.builder()
            .pointKey("A")
            .memberId(1L)
            .amount(Money.of(1000))
            .availableAmount(Money.of(1000))
            .expirationDate(LocalDate.now().plusDays(365))
            .isManualGrant(false)
            .status(PointAccumulationStatus.ACCUMULATED)
            .build();
        
        // when
        PointAccumulation saved = adapter.save(accumulation);
        Optional<PointAccumulation> found = adapter.findByPointKey("A");
        
        // then
        assertThat(found).isPresent();
        assertThat(found.get().getAmount()).isEqualTo(Money.of(1000));
    }
}
```

#### 4.1.2 서비스 통합 테스트

**테스트 파일 위치**:
```
src/test/java/com/musinsa/payments/point/service/
```

**테스트 케이스 예시**:

```java
@SpringBootTest
@Transactional
@DisplayName("포인트 적립 서비스 통합 테스트")
class PointAccumulationServiceIntegrationTest {
    
    @Autowired
    private PointAccumulationService service;
    
    @Autowired
    private PointConfigRepository configRepository;
    
    @Test
    @DisplayName("포인트 적립 전체 플로우")
    void accumulate_fullFlow() {
        // given
        AccumulatePointRequest request = AccumulatePointRequest.builder()
            .memberId(1L)
            .amount(1000L)
            .expirationDays(365)
            .isManualGrant(false)
            .build();
        
        // when
        AccumulatePointResponse response = service.accumulate(request);
        
        // then
        assertThat(response.getPointKey()).isNotNull();
        assertThat(response.getAmount()).isEqualTo(1000L);
        assertThat(response.getAvailableAmount()).isEqualTo(1000L);
    }
}
```

### 4.2 테스트 데이터베이스

- **H2 Database**: 인메모리 데이터베이스 사용
- **Testcontainers**: Docker 기반 통합 테스트 (옵션)

### 4.3 테스트 설정

**application-test.yml**:
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
  h2:
    console:
      enabled: true
```

## 5. API 테스트 (E2E Test)

### 5.1 테스트 대상

#### 5.1.1 REST API 테스트

**테스트 파일 위치**:
```
src/test/java/com/musinsa/payments/point/adapter/in/web/
```

**테스트 케이스 예시**:

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
@DisplayName("포인트 적립 API 테스트")
class PointAccumulationControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    @DisplayName("포인트 적립 API 호출")
    void accumulate_success() throws Exception {
        // given
        AccumulatePointRequest request = AccumulatePointRequest.builder()
            .memberId(1L)
            .amount(1000L)
            .expirationDays(365)
            .isManualGrant(false)
            .build();
        
        // when & then
        mockMvc.perform(post("/api/points/accumulate")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.success").value(true))
            .andExpect(jsonPath("$.data.amount").value(1000));
    }
    
    @Test
    @DisplayName("포인트 적립 API - 유효하지 않은 금액")
    void accumulate_invalidAmount() throws Exception {
        // given
        AccumulatePointRequest request = AccumulatePointRequest.builder()
            .memberId(1L)
            .amount(0L)  // 유효하지 않은 금액
            .build();
        
        // when & then
        mockMvc.perform(post("/api/points/accumulate")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isBadRequest());
    }
}
```

### 5.2 테스트 도구

- **MockMvc**: Spring MVC 테스트
- **RestAssured**: REST API 테스트 (옵션)
- **WireMock**: 외부 API 모킹 (옵션)

## 6. 예시 시나리오 기반 테스트

### 6.1 시나리오 1: 기본 적립 및 사용

```java
@SpringBootTest
@Transactional
@DisplayName("시나리오 1: 기본 적립 및 사용")
class Scenario1Test {
    
    @Autowired
    private PointAccumulationService accumulationService;
    
    @Autowired
    private PointUsageService usageService;
    
    @Test
    void scenario1_basicAccumulationAndUsage() {
        // 1. 1000원 적립 (pointKey: A)
        AccumulatePointRequest request1 = AccumulatePointRequest.builder()
            .memberId(1L)
            .amount(1000L)
            .build();
        AccumulatePointResponse response1 = accumulationService.accumulate(request1);
        String pointKeyA = response1.getPointKey();
        
        // 검증: 총 잔액 1000원
        assertThat(response1.getAmount()).isEqualTo(1000L);
        assertThat(response1.getAvailableAmount()).isEqualTo(1000L);
        
        // 2. 500원 적립 (pointKey: B)
        AccumulatePointRequest request2 = AccumulatePointRequest.builder()
            .memberId(1L)
            .amount(500L)
            .build();
        AccumulatePointResponse response2 = accumulationService.accumulate(request2);
        String pointKeyB = response2.getPointKey();
        
        // 검증: 총 잔액 1500원
        // ...
        
        // 3. 주문번호 A1234에서 1200원 사용 (pointKey: C)
        UsePointRequest request3 = UsePointRequest.builder()
            .memberId(1L)
            .orderNumber("A1234")
            .amount(1200L)
            .build();
        UsePointResponse response3 = usageService.use(request3);
        
        // 검증: 총 잔액 300원
        // 검증: A에서 1000원 사용, B에서 200원 사용
        // ...
    }
}
```

### 6.2 시나리오 2: 만료 포인트 처리

```java
@SpringBootTest
@Transactional
@DisplayName("시나리오 2: 만료 포인트 사용 취소")
class Scenario2Test {
    
    @Test
    void scenario2_expiredPointCancellation() {
        // 1. 포인트 적립 및 사용
        // ...
        
        // 2. A 적립 만료 처리 (시간 조작 또는 직접 만료일 설정)
        // ...
        
        // 3. 사용 취소 (1100원)
        CancelUsageRequest request = CancelUsageRequest.builder()
            .amount(1100L)
            .reason("주문 취소")
            .build();
        CancelUsageResponse response = cancellationService.cancelUsage(pointKeyC, request);
        
        // 검증: 총 잔액 1400원
        // 검증: A는 만료되었으므로 신규 적립 처리 (pointKey: E, 1000원)
        // 검증: B는 만료되지 않았으므로 사용 가능 잔액 복원 (300 → 400원)
        // ...
    }
}
```

## 7. 테스트 커버리지

### 7.1 커버리지 목표

- **라인 커버리지**: 80% 이상
- **브랜치 커버리지**: 75% 이상
- **도메인 로직**: 90% 이상

### 7.2 커버리지 도구

- **JaCoCo**: 코드 커버리지 측정
- **Gradle/Maven 플러그인**: 빌드 시 커버리지 리포트 생성

### 7.3 커버리지 리포트

빌드 후 다음 위치에서 확인:
```
build/reports/jacoco/test/html/index.html
```

## 8. 테스트 실행

### 8.1 로컬 실행

```bash
# 모든 테스트 실행
./gradlew test

# 특정 테스트 클래스 실행
./gradlew test --tests "PointAccumulationTest"

# 커버리지 리포트 생성
./gradlew test jacocoTestReport
```

### 8.2 CI/CD 통합

- **GitHub Actions**: PR 생성 시 자동 테스트 실행
- **코드 커버리지**: PR 코멘트로 커버리지 리포트 표시

## 9. 테스트 데이터 관리

### 9.1 테스트 픽스처

- **@Sql**: SQL 스크립트로 테스트 데이터 준비
- **Test Fixture Builder**: 빌더 패턴으로 테스트 데이터 생성

### 9.2 테스트 격리

- **@Transactional**: 각 테스트 후 롤백
- **@DirtiesContext**: 컨텍스트 재생성 (필요 시)

## 10. 다음 단계

다음 단계에서는 문서화 계획을 수립하여 프로젝트의 빌드 방법과 사용법을 정리할 예정입니다.

---

**다음 문서**: [10. 문서화 계획](./10-문서화-계획.md)

