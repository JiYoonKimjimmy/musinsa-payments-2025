# 05. λΉ„μ¦λ‹μ¤ λ΅μ§ μ„¤κ³„

## 1. κ°μ”

ν¬μΈνΈ μ‹μ¤ν…μ ν•µμ‹¬ λΉ„μ¦λ‹μ¤ λ΅μ§μ„ μ„¤κ³„ν•©λ‹λ‹¤. μ λ¦½, μ λ¦½ μ·¨μ†, μ‚¬μ©, μ‚¬μ© μ·¨μ†μ κ° κΈ°λ¥λ³„λ΅ μ„λΉ„μ¤ λ μ΄μ–΄λ¥Ό κµ¬μ„±ν•©λ‹λ‹¤.

## 2. μ„λΉ„μ¤ λ μ΄μ–΄ κµ¬μ΅°

### 2.1 ν¨ν‚¤μ§€ κµ¬μ΅°

```
com.musinsa.payments.point.application
β”β”€β”€ service/
β”‚   β”β”€β”€ PointAccumulationService           # μ λ¦½ μ„λΉ„μ¤
β”‚   β”β”€β”€ PointUsageService                  # μ‚¬μ© μ„λΉ„μ¤
β”‚   β”β”€β”€ PointCancellationService           # μ·¨μ† μ„λΉ„μ¤
β”‚   β”β”€β”€ PointQueryService                  # μ΅°ν μ„λΉ„μ¤
β”‚   β”β”€β”€ PointConfigService                 # μ„¤μ • κ΄€λ¦¬ μ„λΉ„μ¤
β”‚   β”β”€β”€ PointConfigValidator               # μ„¤μ • κ²€μ¦ μ„λΉ„μ¤
β”‚   β”β”€β”€ PointBalanceReconciliationService  # μ”μ•΅ μ •ν•©μ„± λ³΄μ • μ„λΉ„μ¤
β”‚   β””β”€β”€ PointBalanceCacheUpdateService     # μ”μ•΅ μΊμ‹ μ—…λ°μ΄νΈ μ„λΉ„μ¤ (μ¬μ‹λ„ ν¬ν•¨)
β”β”€β”€ event/
β”‚   β”β”€β”€ PointBalanceEventHandler           # μ”μ•΅ μ΄λ²¤νΈ ν•Έλ“¤λ¬ (λΉ„λ™κΈ°)
β”‚   β””β”€β”€ BalanceReconciliationEventHandler  # μ”μ•΅ λ³΄μ • μ”μ²­ μ΄λ²¤νΈ ν•Έλ“¤λ¬
β””β”€β”€ port/
    β”β”€β”€ input/                             # μΈλ°”μ΄λ“ ν¬νΈ (UseCase μΈν„°νμ΄μ¤)
    β””β”€β”€ output/                            # μ•„μ›ƒλ°”μ΄λ“ ν¬νΈ (Repository, Event μΈν„°νμ΄μ¤)
```

### 2.2 μ΄λ²¤νΈ κΈ°λ° μ”μ•΅ κ΄€λ¦¬

ν¬μΈνΈ κ±°λ(μ λ¦½/μ‚¬μ©/μ·¨μ†) λ°μƒ μ‹ `MemberPointBalance` μΊμ‹ ν…μ΄λΈ”μ„ λΉ„λ™κΈ°λ΅ μ—…λ°μ΄νΈν•©λ‹λ‹¤.

```
[ν¬μΈνΈ μ„λΉ„μ¤] β”€β”€β”€ νΈλμ­μ… μ»¤λ°‹ β”€β”€β”€β†’ [μ΄λ²¤νΈ λ°ν–‰] β”€β”€β”€ λΉ„λ™κΈ° β”€β”€β”€β†’ [PointBalanceEventHandler]
                                                                          β”‚
                                                                          β†“
                                                         [PointBalanceCacheUpdateService]
                                                                          β”‚
                                                        β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”΄β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                                                        β†“                                   β†“
                                                      [μ„±κ³µ]                            [μ‹¤ν¨ β†’ μ¬μ‹λ„]
                                                        β”‚                                   β”‚
                                                        β†“                                (μµλ€ 3ν)
                                            [MemberPointBalance μ—…λ°μ΄νΈ]                     β”‚
                                                                                             β†“
                                                                                        [μµμΆ… μ‹¤ν¨ μ‹]
                                                                                             β”‚
                                                                                             β†“
                                                                           [BalanceReconciliationRequestEvent λ°ν–‰]
                                                                                              β”‚
                                                                                              β†“
                                                                            [BalanceReconciliationEventHandler]
                                                                                              β”‚
                                                                                              β†“
                                                                            [SUM μΏΌλ¦¬λ΅ μ •ν™•ν• μ”μ•΅ κ³„μ‚° β†’ μΊμ‹ λ³΄μ •]
```

**ν•µμ‹¬ νΉμ§•**:
- `@TransactionalEventListener(AFTER_COMMIT)`: μ›λ³Έ νΈλμ­μ… μ»¤λ°‹ ν›„ μ΄λ²¤νΈ μ²λ¦¬
- `@Async`: λΉ„λ™κΈ° μ‹¤ν–‰μΌλ΅ λ©”μΈ μ‘λ‹µ μ‹κ°„μ— μν–¥ μ—†μ
- μΊμ‹ ν…μ΄λΈ”: λΉ λ¥Έ μ”μ•΅ μ΅°νλ¥Ό μ„ν• O(1) μ΅°ν μ§€μ›

#### 2.2.1 μ¬μ‹λ„ λ° λ³µκµ¬ λ§¤μ»¤λ‹μ¦

μΊμ‹ μ—…λ°μ΄νΈ μ‹¤ν¨μ— λ€λΉ„ν• μ¬μ‹λ„ λ° λ³µκµ¬ λ΅μ§μ΄ κµ¬ν„λμ–΄ μμµλ‹λ‹¤.

**μ¬μ‹λ„ μ •μ±… (PointBalanceCacheUpdateService)**

| ν•­λ©       | κ°’                      |
|----------|------------------------|
| μµλ€ μ‹λ„ νμ | 3ν                     |
| λ°±μ¤ν”„ μ „λµ   | μ§€μ λ°±μ¤ν”„ (1μ΄ β†’ 2μ΄ β†’ 4μ΄)  |
| μ¬μ‹λ„ λ€μƒ   | λ¨λ“  Exception           |
| νΈλμ­μ… μ „ν  | REQUIRES_NEW (λ…λ¦½ νΈλμ­μ…) |
| μµμΆ… μ‹¤ν¨ μ‹  | μ”μ•΅ λ³΄μ • μ”μ²­ μ΄λ²¤νΈ λ°ν–‰        |

**λ³µκµ¬ νλ¦„ (BalanceReconciliationEventHandler)**
1. λ³΄μ • μ”μ²­ μ΄λ²¤νΈ μμ‹ 
2. `PointBalanceReconciliationService` νΈμ¶
3. SUM μΏΌλ¦¬λ΅ μ‹¤μ  μ”μ•΅ κ³„μ‚°
4. μΊμ‹ ν…μ΄λΈ” λ³΄μ •

> π“ μμ„Έν• λ‚΄μ©μ€ [11. ν–¥ν›„ κ°μ„  μ‚¬ν•­](./11-ν–¥ν›„-κ°μ„ -μ‚¬ν•­.md)μ "Transactional Outbox Pattern" μ„Ήμ…μ„ μ°Έμ΅°ν•μ„Έμ”.

---

## 3. ν¬μΈνΈ μ λ¦½ μ„λΉ„μ¤

### 3.1 PointAccumulationService

**μ±…μ„**:
- μ λ¦½ μ”μ²­ κ²€μ¦
- μ„¤μ • μ΅°ν λ° μ μ©
- μ”μ•΅ ν™•μΈ λ° κ²€μ¦
- ν¬μΈνΈ μ λ¦½ μƒμ„± λ° μ €μ¥
- μ”μ•΅ μ—…λ°μ΄νΈ μ΄λ²¤νΈ λ°ν–‰

**μμ΅΄μ„±**:

| μμ΅΄ μ»΄ν¬λ„νΈ                          | μ©λ„         |
|----------------------------------|------------|
| PointAccumulationPersistencePort | μ λ¦½ κ±΄ μ €μ¥/μ΅°ν |
| PointConfigService               | μ„¤μ • κ°’ μ΅°ν    |
| PointKeyGenerator                | ν¬μΈνΈ ν‚¤ μƒμ„±   |
| PointBalanceEventPublisher       | μ”μ•΅ μ΄λ²¤νΈ λ°ν–‰  |

**μ λ¦½ μ²λ¦¬ νλ¦„**:

| λ‹¨κ³„ | μ²λ¦¬ λ‚΄μ©                                            |
|----|--------------------------------------------------|
| 1  | μ λ¦½ κΈμ•΅ κ²€μ¦ (0λ³΄λ‹¤ μ»¤μ•Ό ν•¨)                              |
| 2  | μµλ€ μ λ¦½ κΈμ•΅ κ²€μ¦ (μ„¤μ •κ°’ κΈ°μ¤€)                             |
| 3  | μµλ€ λ³΄μ  κΈμ•΅ κ²€μ¦ (ν„μ¬ μ”μ•΅ + μ λ¦½ κΈμ•΅)                      |
| 4  | λ§λ£μΌ κ³„μ‚° λ° κ²€μ¦                                      |
| 5  | ν¬μΈνΈ ν‚¤ μƒμ„±                                         |
| 6  | ν¬μΈνΈ μ λ¦½ μ—”ν‹°ν‹° μƒμ„±                                    |
| 7  | μ €μ¥                                               |
| 8  | μ”μ•΅ μ—…λ°μ΄νΈ μ΄λ²¤νΈ λ°ν–‰ (`PointBalanceEvent.Accumulated`) |

**μ λ¦½ μ·¨μ† μ²λ¦¬ νλ¦„**:

| λ‹¨κ³„ | μ²λ¦¬ λ‚΄μ©                                                      |
|----|------------------------------------------------------------|
| 1  | μ λ¦½ κ±΄ μ΅°ν (by pointKey)                                      |
| 2  | μ·¨μ†ν•  κΈμ•΅ ν™•μΈ (μ‚¬μ© κ°€λ¥ μ”μ•΅)                                       |
| 3  | μ λ¦½ μ·¨μ† μ²λ¦¬ (λ„λ©”μΈ λ©”μ„λ“ νΈμ¶)                                      |
| 4  | μ €μ¥                                                         |
| 5  | μ”μ•΅ μ—…λ°μ΄νΈ μ΄λ²¤νΈ λ°ν–‰ (`PointBalanceEvent.AccumulationCancelled`) |

---

## 4. ν¬μΈνΈ μ‚¬μ© μ„λΉ„μ¤

### 4.1 PointUsageService

**μ±…μ„**:
- μ‚¬μ© κ°€λ¥ν• μ λ¦½ κ±΄ μ΅°ν (λΉ„κ΄€μ  λ½ μ μ©)
- μ°μ„ μμ„μ— λ”°λ¥Έ μ λ¦½ κ±΄ μ„ νƒ
- ν¬μΈνΈ μ‚¬μ© λ° μ λ¦½ κ±΄λ³„ μƒμ„Έ λ‚΄μ—­ μƒμ„±
- μ λ¦½ κ±΄μ μ‚¬μ© κ°€λ¥ μ”μ•΅ μ—…λ°μ΄νΈ (λ°°μΉ μ²λ¦¬)
- μ”μ•΅ μ—…λ°μ΄νΈ μ΄λ²¤νΈ λ°ν–‰

**μμ΅΄μ„±**:

| μμ΅΄ μ»΄ν¬λ„νΈ                          | μ©λ„         |
|----------------------------------|------------|
| PointAccumulationPersistencePort | μ λ¦½ κ±΄ μ΅°ν/μ €μ¥ |
| PointUsagePersistencePort        | μ‚¬μ© κ±΄ μ €μ¥    |
| PointUsageDetailPersistencePort  | μ‚¬μ© μƒμ„Έ μ €μ¥   |
| PointKeyGenerator                | ν¬μΈνΈ ν‚¤ μƒμ„±   |
| PointUsagePriorityService        | μ‚¬μ© μ°μ„ μμ„ κ²°μ • |
| PointBalanceEventPublisher       | μ”μ•΅ μ΄λ²¤νΈ λ°ν–‰  |

**νΈλμ­μ… μ„¤μ •**:
- κ²©λ¦¬ μμ¤€: `READ_COMMITTED`
- λΉ„κ΄€μ  λ½μ„ ν†µν•΄ μ λ¦½ κ±΄μ λ™μ‹ μ ‘κ·Ό μ μ–΄

**μ‚¬μ© μ²λ¦¬ νλ¦„**:

| λ‹¨κ³„ | μ²λ¦¬ λ‚΄μ©                                     |
|----|-------------------------------------------|
| 1  | μ‚¬μ© κΈμ•΅ κ²€μ¦ (0λ³΄λ‹¤ μ»¤μ•Ό ν•¨)                       |
| 2  | μ‚¬μ© κ°€λ¥ μ”μ•΅ ν™•μΈ                               |
| 3  | μ‚¬μ© κ°€λ¥ν• μ λ¦½ κ±΄ μ΅°ν (λΉ„κ΄€μ  λ½ μ μ©)                 |
| 4  | μ°μ„ μμ„μ— λ”°λΌ μ λ¦½ κ±΄ μ„ νƒ                          |
| 5  | ν¬μΈνΈ μ‚¬μ© μ—”ν‹°ν‹° μƒμ„± λ° μ €μ¥                        |
| 6  | κ° μ λ¦½ κ±΄λ³„ μ‚¬μ© μ²λ¦¬ λ° μƒμ„Έ λ‚΄μ—­ μƒμ„±                  |
| 7  | μƒμ„Έ λ‚΄μ—­ μ €μ¥                                  |
| 8  | μ”μ•΅ μ—…λ°μ΄νΈ μ΄λ²¤νΈ λ°ν–‰ (`PointBalanceEvent.Used`) |

**μ„±λ¥ μµμ ν™”**:
- μƒμ„Έ λ‚΄μ—­ μ €μ¥: 1ν¬μΈνΈ λ‹¨μ„ κ°λ³„ μ €μ¥ β†’ μ λ¦½ κ±΄λ‹Ή 1κ° λ μ½”λ“
  - 10,000ν¬μΈνΈ μ‚¬μ© μ‹: 10,000κ° β†’ 1κ° λ μ½”λ“ (99.99% κ°μ†)
- μ λ¦½ κ±΄ μ €μ¥: `saveAll()`μ„ ν†µν• λ°°μΉ μ²λ¦¬
- ν•¨μν• ν”„λ΅κ·Έλλ° μ¤νƒ€μΌ(`fold`)μ„ ν™μ©ν• λ¶λ³€μ„± μ μ§€

### 4.2 PointUsagePriorityService (λ„λ©”μΈ μ„λΉ„μ¤)

**μ±…μ„**:
- ν¬μΈνΈ μ‚¬μ© μ°μ„ μμ„ κ²°μ •
- μ‚¬μ©ν•  μ λ¦½ κ±΄ μ„ νƒ

**μ°μ„ μμ„ κ·μΉ™**:

| μμ„  | μ΅°κ±΄                               | μ •λ ¬   |
|-----|----------------------------------|------|
| 1μμ„ | μκΈ° μ§€κΈ‰ ν¬μΈνΈ (isManualGrant = true) | λ‚΄λ¦Όμ°¨μ |
| 2μμ„ | λ§λ£μΌμ΄ μ§§μ€ μμ„                       | μ¤λ¦„μ°¨μ |

**μ£Όμ” κΈ°λ¥**:

| λ©”μ„λ“                              | μ„¤λ…                   |
|----------------------------------|----------------------|
| selectAccumulationsForUsage(...) | μ°μ„ μμ„μ— λ”°λΌ μ‚¬μ©ν•  μ λ¦½ κ±΄ μ„ νƒ |

---

## 5. ν¬μΈνΈ μ·¨μ† μ„λΉ„μ¤

### 5.1 PointCancellationService

**μ±…μ„**:
- μ‚¬μ© κ±΄ μ΅°ν λ° κ²€μ¦
- μ‚¬μ© μƒμ„Έ λ‚΄μ—­ μ·¨μ† μ²λ¦¬
- λ§λ£λ ν¬μΈνΈλ” μ‹ κ· μ λ¦½ μ²λ¦¬
- λ§λ£λμ§€ μ•μ€ ν¬μΈνΈλ” μ‚¬μ© κ°€λ¥ μ”μ•΅ λ³µμ›
- μ”μ•΅ μ—…λ°μ΄νΈ μ΄λ²¤νΈ λ°ν–‰

**μμ΅΄μ„±**:

| μμ΅΄ μ»΄ν¬λ„νΈ                          | μ©λ„          |
|----------------------------------|-------------|
| PointUsagePersistencePort        | μ‚¬μ© κ±΄ μ΅°ν/μ €μ¥  |
| PointUsageDetailPersistencePort  | μ‚¬μ© μƒμ„Έ μ΅°ν/μ €μ¥ |
| PointAccumulationPersistencePort | μ λ¦½ κ±΄ μ΅°ν/μ €μ¥  |
| PointKeyGenerator                | ν¬μΈνΈ ν‚¤ μƒμ„±    |
| PointConfigService               | μ„¤μ • κ°’ μ΅°ν     |
| PointBalanceEventPublisher       | μ”μ•΅ μ΄λ²¤νΈ λ°ν–‰   |

**νΈλμ­μ… μ„¤μ •**:
- κ²©λ¦¬ μμ¤€: `READ_COMMITTED`
- λΉ„κ΄€μ  λ½μ„ ν†µν•΄ μ λ¦½ κ±΄μ λ™μ‹ μ ‘κ·Ό μ μ–΄

**μ‚¬μ© μ·¨μ† μ²λ¦¬ νλ¦„**:

| λ‹¨κ³„ | μ²λ¦¬ λ‚΄μ©                                               |
|----|-----------------------------------------------------|
| 1  | μ‚¬μ© κ±΄ μ΅°ν (by pointKey)                               |
| 2  | μ·¨μ† κΈμ•΅ κ²°μ • (nullμ΄λ©΄ μ „μ²΄ μ·¨μ†)                             |
| 3  | μ·¨μ† κ°€λ¥ μ—¬λ¶€ ν™•μΈ                                         |
| 4  | μ‚¬μ© μƒμ„Έ λ‚΄μ—­ μ΅°ν                                         |
| 5  | μƒμ„Έ λ‚΄μ—­λ³„ μ·¨μ† μ²λ¦¬                                        |
| 6  | μ λ¦½ κ±΄ λ³µμ› μ²λ¦¬ (λ§λ£ ν¬μΈνΈ ν™•μΈ)                              |
| 7  | μ‚¬μ© κ±΄ μ·¨μ† μ²λ¦¬ λ° μ €μ¥                                     |
| 8  | μ”μ•΅ μ—…λ°μ΄νΈ μ΄λ²¤νΈ λ°ν–‰ (`PointBalanceEvent.UsageCancelled`) |

**λ§λ£ ν¬μΈνΈ μ²λ¦¬ λ΅μ§**:

| μ΅°κ±΄          | μ²λ¦¬                     |
|-------------|------------------------|
| λ§λ£λμ§€ μ•μ€ ν¬μΈνΈ | κΈ°μ΅΄ μ λ¦½ κ±΄μ μ‚¬μ© κ°€λ¥ μ”μ•΅ λ³µμ›   |
| λ§λ£λ ν¬μΈνΈ     | μ‹ κ· μ λ¦½ κ±΄ μƒμ„± (κΈ°λ³Έ λ§λ£μΌ μ μ©) |

---

## 6. ν¬μΈνΈ μ΅°ν μ„λΉ„μ¤

### 6.1 PointQueryService

**μ±…μ„**:
- ν¬μΈνΈ μ”μ•΅ μ΅°ν
- ν¬μΈνΈ μ‚¬μ© λ‚΄μ—­ μ΅°ν

**μμ΅΄μ„±**:

| μμ΅΄ μ»΄ν¬λ„νΈ                           | μ©λ„        |
|-----------------------------------|-----------|
| PointAccumulationPersistencePort  | μ λ¦½ κ±΄ μ΅°ν   |
| PointUsagePersistencePort         | μ‚¬μ© κ±΄ μ΅°ν   |
| MemberPointBalancePersistencePort | μΊμ‹λ μ”μ•΅ μ΅°ν |

**νΈλμ­μ… μ„¤μ •**:
- `@Transactional(readOnly = true)`

**μ”μ•΅ μ΅°ν μ „λµ (ν•μ΄λΈλ¦¬λ“)**:

| μ΅°ν λ°©μ‹                 | μ‚¬μ© μ‹μ     | νΉμ§•         |
|-----------------------|----------|------------|
| MemberPointBalance μΊμ‹ | μΌλ° μ”μ•΅ μ΅°ν | O(1) λΉ λ¥Έ μ΅°ν |
| SUM μΏΌλ¦¬ (Fallback)     | μΊμ‹ μ—†λ” κ²½μ° | μ λ¦½ κ±΄ μ§μ ‘ ν•©μ‚° |

---

## 7. ν¬μΈνΈ μ„¤μ • μ„λΉ„μ¤

### 7.1 PointConfigService

**μ±…μ„**:
- μ„¤μ • μ΅°ν (μΊμ‹± μ μ©)
- μ„¤μ • μ—…λ°μ΄νΈ
- μ„¤μ • λ³€κ²½ μ΄λ ¥ κΈ°λ΅

**μμ΅΄μ„±**:

| μμ΅΄ μ»΄ν¬λ„νΈ                | μ©λ„       |
|------------------------|----------|
| PointConfigPort        | μ„¤μ • μ €μ¥/μ΅°ν |
| PointConfigValidator   | μ„¤μ • κ°’ κ²€μ¦  |
| PointConfigHistoryPort | λ³€κ²½ μ΄λ ¥ μ €μ¥ |

**μΊμ‹± μ „λµ**:
- `@Cacheable(value = ["pointConfig"])`: μ„¤μ • μ΅°ν μ‹ μΊμ‹±
- `@CacheEvict(allEntries = true)`: μ„¤μ • μ—…λ°μ΄νΈ μ‹ μΊμ‹ λ¬΄ν¨ν™”

**μ κ³µ λ©”μ„λ“**:

| λ©”μ„λ“                  | μ„¤λ…                 |
|----------------------|--------------------|
| findByConfigKey(key) | μ„¤μ • ν‚¤λ΅ μ΅°ν           |
| findAll()            | λ¨λ“  μ„¤μ • μ΅°ν           |
| getLongValue(key)    | Long νƒ€μ… μ„¤μ • κ°’ μ΅°ν    |
| getIntValue(key)     | Int νƒ€μ… μ„¤μ • κ°’ μ΅°ν     |
| getBooleanValue(key) | Boolean νƒ€μ… μ„¤μ • κ°’ μ΅°ν |
| updateConfig(...)    | μ„¤μ • μ—…λ°μ΄νΈ λ° μ΄λ ¥ κΈ°λ΅    |

### 7.2 PointConfigValidator

**μ±…μ„**:
- μ„¤μ • κ°’ μ ν¨μ„± κ²€μ¦
- μ„¤μ • κ°„ μμ΅΄μ„± κ²€μ¦

**κ²€μ¦ κ·μΉ™**:

| μ„¤μ • ν‚¤                             | κ²€μ¦ νƒ€μ… | λ²”μ„                 |
|----------------------------------|-------|--------------------|
| MAX_ACCUMULATION_AMOUNT_PER_TIME | Long  | 1 ~ Long.MAX_VALUE |
| MAX_BALANCE_PER_MEMBER           | Long  | 1 ~ Long.MAX_VALUE |
| DEFAULT_EXPIRATION_DAYS          | Int   | 1 ~ 1824           |
| MIN_EXPIRATION_DAYS              | Int   | 1 ~ 1824           |
| MAX_EXPIRATION_DAYS              | Int   | 1 ~ 1824           |

**μμ΅΄μ„± κ²€μ¦**:
- `MIN_EXPIRATION_DAYS < DEFAULT_EXPIRATION_DAYS < MAX_EXPIRATION_DAYS`

---

## 8. ν¬μΈνΈ μ”μ•΅ μ •ν•©μ„± λ³΄μ • μ„λΉ„μ¤

### 8.1 PointBalanceReconciliationService

**μ±…μ„**:
- μΊμ‹λ μ”μ•΅κ³Ό μ‹¤μ  μ λ¦½ κ±΄ ν•©κ³„ λΉ„κµ
- λ¶μΌμΉ λ°κ²¬ μ‹ μΊμ‹ λ³΄μ •
- μΊμ‹ μ—†λ” κ²½μ° μ‹ κ· μƒμ„±

**μμ΅΄μ„±**:

| μμ΅΄ μ»΄ν¬λ„νΈ                           | μ©λ„                |
|-----------------------------------|-------------------|
| MemberPointBalancePersistencePort | μΊμ‹λ μ”μ•΅ μ΅°ν/μ €μ¥      |
| PointAccumulationPersistencePort  | μ‹¤μ  μ”μ•΅ κ³„μ‚° (SUM μΏΌλ¦¬) |

**λ³΄μ • μƒνƒ**:

| μƒνƒ        | μ„¤λ…           |
|-----------|--------------|
| MATCHED   | μ”μ•΅ μΌμΉ        |
| CORRECTED | λ¶μΌμΉ λ°κ²¬ λ° λ³΄μ •λ¨ |
| CREATED   | μ”μ•΅ μΊμ‹ μ‹ κ· μƒμ„±λ¨ |
| SKIPPED   | μ”μ•΅μ΄ μ—†μ–΄ κ±΄λ„λ€   |

**μ κ³µ λ©”μ„λ“**:

| λ©”μ„λ“                              | μ„¤λ…                   |
|----------------------------------|----------------------|
| reconcileMemberBalance(memberId) | νΉμ • νμ› μ”μ•΅ μ •ν•©μ„± κ²€μ¦ λ° λ³΄μ • |
| reconcileAllBalances()           | μ „μ²΄ νμ› μ”μ•΅ μ •ν•©μ„± κ²€μ¦ λ° λ³΄μ • |

---

## 9. νΈλμ­μ… κ²½κ³„

### 9.1 νΈλμ­μ… μ „λµ

| μ–΄λ…Έν…μ΄μ…                                        | μ‚¬μ© μΌ€μ΄μ¤       |
|----------------------------------------------|--------------|
| `@Transactional`                             | μ“°κΈ° μ‘μ—… (κΈ°λ³Έ)   |
| `@Transactional(readOnly = true)`            | μ½κΈ° μ „μ© μ‘μ—…     |
| `@Transactional(isolation = READ_COMMITTED)` | λ™μ‹μ„± μ μ–΄ ν•„μ” μ‘μ—… |
| `@Transactional(propagation = REQUIRES_NEW)` | λ…λ¦½ νΈλμ­μ… ν•„μ” μ‹ |

### 9.2 νΈλμ­μ… λ²”μ„

| κΈ°λ¥      | νΈλμ­μ… λ²”μ„                                     |
|---------|---------------------------------------------|
| μ λ¦½      | μ λ¦½ κ±΄ μ €μ¥, μ„¤μ • μ΅°ν, μ΄λ²¤νΈ λ°ν–‰                      |
| μ λ¦½ μ·¨μ†   | μ λ¦½ κ±΄ μ—…λ°μ΄νΈ, μ΄λ²¤νΈ λ°ν–‰                           |
| μ‚¬μ©      | μ‚¬μ© κ±΄ μ €μ¥, μƒμ„Έ λ‚΄μ—­ μ €μ¥, μ λ¦½ κ±΄ μΌκ΄„ μ €μ¥, μ΄λ²¤νΈ λ°ν–‰       |
| μ‚¬μ© μ·¨μ†   | μ‚¬μ© κ±΄ μ—…λ°μ΄νΈ, μƒμ„Έ λ‚΄μ—­ μ—…λ°μ΄νΈ, μ λ¦½ κ±΄ μ—…λ°μ΄νΈ/μƒμ„±, μ΄λ²¤νΈ λ°ν–‰ |
| μΊμ‹ μ—…λ°μ΄νΈ | λ…λ¦½ νΈλμ­μ… (REQUIRES_NEW)                      |

---

## 10. λ™μ‹μ„± μ μ–΄ μ „λµ

### 10.1 λ™μ‹μ„± μ΄μ μ‹λ‚λ¦¬μ¤

| μ‹λ‚λ¦¬μ¤          | μ„¤λ…                              |
|---------------|---------------------------------|
| λ™μΌ μ‚¬μ©μ λ™μ‹ μ‚¬μ©  | μ—¬λ¬ μ”μ²­μ΄ λ™μ‹μ— κ°™μ€ μ λ¦½ κ±΄μ„ μ‚¬μ©ν•λ ¤λ” κ²½μ°    |
| μ λ¦½κ³Ό μ‚¬μ©μ λ™μ‹ λ°μƒ | μ λ¦½ μ²λ¦¬ μ¤‘μ— ν•΄λ‹Ή μ λ¦½ κ±΄ μ‚¬μ© μ”μ²­μ΄ λ“¤μ–΄μ¤λ” κ²½μ° |
| μ‚¬μ© μ·¨μ† λ™μ‹ μ”μ²­   | κ°™μ€ μ‚¬μ© κ±΄μ— λ€ν•΄ λ™μ‹μ— μ·¨μ† μ”μ²­μ΄ λ“¤μ–΄μ¤λ” κ²½μ°  |

### 10.2 ν•΄κ²° μ „λµ

#### 10.2.1 λΉ„κ΄€μ  λ½ (Pessimistic Lock)

| μ μ© μ‹μ       | λ©”μ„λ“                                            |
|------------|------------------------------------------------|
| ν¬μΈνΈ μ‚¬μ©     | findAvailableAccumulationsByMemberIdWithLock() |
| μ‚¬μ© μ·¨μ†      | findByIdWithLock()                             |
| μ”μ•΅ μΊμ‹ μ—…λ°μ΄νΈ | findByMemberIdWithLock()                       |

#### 10.2.2 νΈλμ­μ… κ²©λ¦¬ μμ¤€

| μ„λΉ„μ¤                      | κ²©λ¦¬ μμ¤€          | μ΄μ                   |
|--------------------------|----------------|---------------------|
| PointUsageService        | READ_COMMITTED | λΉ„κ΄€μ  λ½κ³Ό ν•¨κ» μ‚¬μ©, μ„±λ¥ κ· ν• |
| PointCancellationService | READ_COMMITTED | λΉ„κ΄€μ  λ½κ³Ό ν•¨κ» μ‚¬μ©, μ„±λ¥ κ· ν• |

### 10.3 λ°λ“λ½ λ°©μ§€

| μ „λµ       | μ„¤λ…                               |
|----------|----------------------------------|
| μμ„ λ³΄μ¥    | μ λ¦½ κ±΄ μ΅°ν μ‹ ν•­μƒ ID μ¤λ¦„μ°¨μμΌλ΅ μ •λ ¬ν•μ—¬ λ½ νλ“ |
| νƒ€μ„μ•„μ›ƒ μ„¤μ •  | λ½ λ€κΈ° μ‹κ°„ μ ν• (5μ΄ κ¶μ¥)               |
| λ½ λ²”μ„ μµμ†ν™” | ν•„μ”ν• μµμ† λ²”μ„λ§ λ½ μ μ©                  |

---

## 11. μμ™Έ μ²λ¦¬ μ „λµ

### 11.1 μμ™Έ κ³„μΈµ κµ¬μ΅°

```
RuntimeException
β””β”€β”€ PointDomainException
    β”β”€β”€ InvalidAmountException
    β”β”€β”€ MaxAccumulationExceededException
    β”β”€β”€ MaxBalanceExceededException
    β”β”€β”€ InvalidExpirationDateException
    β”β”€β”€ InsufficientPointException
    β”β”€β”€ CannotCancelAccumulationException
    β”β”€β”€ CannotCancelUsageException
    β”β”€β”€ ConfigNotFoundException
    β”β”€β”€ InvalidConfigKeyException
    β””β”€β”€ InvalidConfigValueException
```

### 11.2 μμ™Έ μ²λ¦¬ νλ¦„

1. **λ„λ©”μΈ μμ™Έ λ°μƒ**: λΉ„μ¦λ‹μ¤ κ·μΉ™ μ„λ° μ‹ λ„λ©”μΈ μμ™Έ λ°μƒ
2. **μ„λΉ„μ¤ λ μ΄μ–΄**: λ„λ©”μΈ μμ™Έλ¥Ό κ·Έλ€λ΅ μ „ν
3. **μ»¨νΈλ΅¤λ¬ λ μ΄μ–΄**: μμ™Έλ¥Ό HTTP μ‘λ‹µμΌλ΅ λ³€ν™

---

## 12. λ‹¤μ λ‹¨κ³„

λ‹¤μ λ‹¨κ³„μ—μ„λ” μ„¤μ • κ΄€λ¦¬ μ„¤κ³„λ¥Ό ν†µν•΄ λ™μ  μ„¤μ • κ΄€λ¦¬ λ°©λ²•μ„ κµ¬μ²΄ν™”ν•  μμ •μ…λ‹λ‹¤.

---

**λ‹¤μ λ¬Έμ„**: [06. μ„¤μ • κ΄€λ¦¬ μ„¤κ³„](./06-μ„¤μ •-κ΄€λ¦¬-μ„¤κ³„.md)
