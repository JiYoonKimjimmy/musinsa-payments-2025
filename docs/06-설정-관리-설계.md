# 06. 설정 관리 설계

## 1. 개요

포인트 시스템의 동적 설정을 관리하는 방법을 설계합니다. 하드코딩이 아닌 별도의 방법으로 설정을 변경할 수 있도록 합니다.

## 2. 설정 항목

### 2.1 필수 설정 항목

| 설정 키 | 설명 | 기본값 | 타입 | 범위 |
|---------|------|--------|------|------|
| `MAX_ACCUMULATION_AMOUNT_PER_TIME` | 1회 최대 적립 금액 | 100000 | Long | 1 이상 |
| `MAX_BALANCE_PER_MEMBER` | 개인별 최대 보유 금액 | - | Long | 1 이상 |
| `DEFAULT_EXPIRATION_DAYS` | 기본 만료일 (일) | 365 | Integer | 1 이상 |
| `MIN_EXPIRATION_DAYS` | 최소 만료일 (일) | 1 | Integer | 1 이상 |
| `MAX_EXPIRATION_DAYS` | 최대 만료일 (일) | 1824 | Integer | 1824 미만 (약 5년) |

### 2.2 설정 항목 상세

#### 2.2.1 MAX_ACCUMULATION_AMOUNT_PER_TIME
- **용도**: 1회 적립 시 최대 금액 제한
- **검증**: 적립 요청 시 이 값을 초과하면 예외 발생
- **변경 가능**: 관리자가 동적으로 변경 가능

#### 2.2.2 MAX_BALANCE_PER_MEMBER
- **용도**: 개인별로 보유할 수 있는 최대 포인트 금액
- **검증**: 적립 시 현재 잔액 + 적립 금액이 이 값을 초과하면 예외 발생
- **변경 가능**: 관리자가 동적으로 변경 가능
- **주의**: 기존 사용자의 잔액이 새로운 최대값을 초과하는 경우 처리 필요

#### 2.2.3 DEFAULT_EXPIRATION_DAYS
- **용도**: 포인트 적립 시 기본 만료일
- **적용**: 적립 요청에 만료일이 명시되지 않은 경우 사용
- **변경 가능**: 관리자가 동적으로 변경 가능

#### 2.2.4 MIN_EXPIRATION_DAYS
- **용도**: 포인트 만료일의 최소값
- **검증**: 적립 요청의 만료일이 이 값보다 작으면 예외 발생
- **변경 가능**: 관리자가 동적으로 변경 가능

#### 2.2.5 MAX_EXPIRATION_DAYS
- **용도**: 포인트 만료일의 최대값
- **검증**: 적립 요청의 만료일이 이 값 이상이면 예외 발생
- **변경 가능**: 관리자가 동적으로 변경 가능

## 3. 설정 저장소 설계

### 3.1 데이터베이스 기반 설정

설정을 데이터베이스 테이블(`point_config`)에 저장하여 동적으로 관리합니다.

#### 3.1.1 장점
- 런타임에 설정 변경 가능
- 설정 변경 이력 관리 가능
- 여러 환경(개발/스테이징/운영)별 설정 관리 가능

#### 3.1.2 단점
- 데이터베이스 의존성
- 설정 조회 시 데이터베이스 접근 필요

### 3.2 설정 조회 전략

#### 3.2.1 캐싱 전략
설정 값을 메모리에 캐싱하여 성능을 최적화합니다.

```java
package com.musinsa.payments.point.config;

@Service
public class PointConfigService {
    
    private final PointConfigRepository configRepository;
    private final Cache<String, PointConfig> configCache;
    
    @PostConstruct
    public void initializeCache() {
        // 애플리케이션 시작 시 모든 설정을 캐시에 로드
        List<PointConfig> configs = configRepository.findAll();
        configs.forEach(config -> 
            configCache.put(config.getConfigKey(), config));
    }
    
    public PointConfig getConfig(String configKey) {
        // 캐시에서 조회, 없으면 DB에서 조회 후 캐시에 저장
        return configCache.get(configKey, key -> 
            configRepository.findByConfigKey(key)
                .orElseThrow(() -> new ConfigNotFoundException(key)));
    }
    
    @CacheEvict(value = "pointConfig", key = "#configKey")
    public void updateConfig(String configKey, String configValue) {
        // 설정 업데이트 시 캐시 무효화
        PointConfig config = configRepository
            .findByConfigKey(configKey)
            .orElseThrow(() -> new ConfigNotFoundException(configKey));
        config.updateValue(configValue);
        configRepository.save(config);
    }
}
```

#### 3.2.2 캐시 무효화 전략
- **즉시 무효화**: 설정 변경 시 해당 키의 캐시를 즉시 무효화
- **TTL 설정**: 일정 시간 후 자동으로 캐시 무효화 (옵션)

## 4. 설정 관리 API

### 4.1 설정 조회 API

#### GET /api/admin/points/config

**설명**: 모든 포인트 설정을 조회합니다.

**Response Body**:
```json
{
  "success": true,
  "data": [
    {
      "configKey": "MAX_ACCUMULATION_AMOUNT_PER_TIME",
      "configValue": "100000",
      "description": "1회 최대 적립 금액",
      "updatedAt": "2025-01-01T10:00:00"
    },
    {
      "configKey": "MAX_BALANCE_PER_MEMBER",
      "configValue": "1000000",
      "description": "개인별 최대 보유 금액",
      "updatedAt": "2025-01-01T10:00:00"
    }
  ]
}
```

### 4.2 설정 업데이트 API

#### PUT /api/admin/points/config/{configKey}

**설명**: 특정 설정 값을 업데이트합니다.

**Path Parameter**:
- `configKey`: 설정 키

**Request Body**:
```json
{
  "configValue": "200000",
  "description": "1회 최대 적립 금액 (업데이트)"
}
```

**Request DTO**:
```java
public class UpdateConfigRequest {
    @NotBlank
    private String configValue;
    
    private String description;
}
```

**Response Body**:
```json
{
  "success": true,
  "data": {
    "configKey": "MAX_ACCUMULATION_AMOUNT_PER_TIME",
    "configValue": "200000",
    "description": "1회 최대 적립 금액 (업데이트)",
    "updatedAt": "2025-01-01T11:00:00"
  }
}
```

**에러 케이스**:
- `404 CONFIG_NOT_FOUND`: 설정을 찾을 수 없음
- `400 INVALID_CONFIG_VALUE`: 설정 값이 유효하지 않음

## 5. 설정 검증 로직

### 5.1 설정 값 검증

```java
package com.musinsa.payments.point.config;

@Service
public class PointConfigValidator {
    
    public void validateConfigValue(String configKey, String configValue) {
        switch (configKey) {
            case "MAX_ACCUMULATION_AMOUNT_PER_TIME":
                validateLongValue(configValue, 1L, Long.MAX_VALUE);
                break;
            case "MAX_BALANCE_PER_MEMBER":
                validateLongValue(configValue, 1L, Long.MAX_VALUE);
                break;
            case "DEFAULT_EXPIRATION_DAYS":
                validateIntegerValue(configValue, 1, 1824);
                break;
            case "MIN_EXPIRATION_DAYS":
                validateIntegerValue(configValue, 1, 1824);
                break;
            case "MAX_EXPIRATION_DAYS":
                validateIntegerValue(configValue, 1, 1824);
                break;
            default:
                throw new InvalidConfigKeyException(configKey);
        }
    }
    
    private void validateLongValue(String value, Long min, Long max) {
        try {
            Long longValue = Long.parseLong(value);
            if (longValue < min || longValue > max) {
                throw new InvalidConfigValueException(
                    String.format("설정 값은 %d 이상 %d 이하여야 합니다.", min, max));
            }
        } catch (NumberFormatException e) {
            throw new InvalidConfigValueException("설정 값은 숫자여야 합니다.");
        }
    }
    
    private void validateIntegerValue(String value, Integer min, Integer max) {
        try {
            Integer intValue = Integer.parseInt(value);
            if (intValue < min || intValue > max) {
                throw new InvalidConfigValueException(
                    String.format("설정 값은 %d 이상 %d 이하여야 합니다.", min, max));
            }
        } catch (NumberFormatException e) {
            throw new InvalidConfigValueException("설정 값은 숫자여야 합니다.");
        }
    }
}
```

### 5.2 설정 간 의존성 검증

```java
public void validateConfigDependencies() {
    PointConfig minDays = getConfig("MIN_EXPIRATION_DAYS");
    PointConfig maxDays = getConfig("MAX_EXPIRATION_DAYS");
    PointConfig defaultDays = getConfig("DEFAULT_EXPIRATION_DAYS");
    
    if (minDays.getIntValue() >= maxDays.getIntValue()) {
        throw new InvalidConfigException(
            "최소 만료일은 최대 만료일보다 작아야 합니다.");
    }
    
    if (defaultDays.getIntValue() < minDays.getIntValue() 
        || defaultDays.getIntValue() >= maxDays.getIntValue()) {
        throw new InvalidConfigException(
            "기본 만료일은 최소 만료일 이상, 최대 만료일 미만이어야 합니다.");
    }
}
```

## 6. 초기 설정 데이터

### 6.1 데이터 초기화

애플리케이션 시작 시 기본 설정 값이 없으면 자동으로 생성합니다.

```java
package com.musinsa.payments.point.config;

@Component
public class PointConfigInitializer {
    
    private final PointConfigRepository configRepository;
    
    @PostConstruct
    public void initializeDefaultConfigs() {
        initializeConfigIfNotExists(
            "MAX_ACCUMULATION_AMOUNT_PER_TIME",
            "100000",
            "1회 최대 적립 금액"
        );
        
        initializeConfigIfNotExists(
            "MAX_BALANCE_PER_MEMBER",
            "10000000",
            "개인별 최대 보유 금액"
        );
        
        initializeConfigIfNotExists(
            "DEFAULT_EXPIRATION_DAYS",
            "365",
            "기본 만료일 (일)"
        );
        
        initializeConfigIfNotExists(
            "MIN_EXPIRATION_DAYS",
            "1",
            "최소 만료일 (일)"
        );
        
        initializeConfigIfNotExists(
            "MAX_EXPIRATION_DAYS",
            "1824",
            "최대 만료일 (일)"
        );
    }
    
    private void initializeConfigIfNotExists(
            String configKey,
            String defaultValue,
            String description) {
        
        if (!configRepository.findByConfigKey(configKey).isPresent()) {
            PointConfig config = PointConfig.builder()
                .configKey(configKey)
                .configValue(defaultValue)
                .description(description)
                .build();
            configRepository.save(config);
        }
    }
}
```

### 6.2 SQL 초기화 스크립트 (옵션)

```sql
-- resources/db/migration/V1__init_point_config.sql

INSERT INTO point_config (config_key, config_value, description, created_at, updated_at)
VALUES 
    ('MAX_ACCUMULATION_AMOUNT_PER_TIME', '100000', '1회 최대 적립 금액', NOW(), NOW()),
    ('MAX_BALANCE_PER_MEMBER', '10000000', '개인별 최대 보유 금액', NOW(), NOW()),
    ('DEFAULT_EXPIRATION_DAYS', '365', '기본 만료일 (일)', NOW(), NOW()),
    ('MIN_EXPIRATION_DAYS', '1', '최소 만료일 (일)', NOW(), NOW()),
    ('MAX_EXPIRATION_DAYS', '1824', '최대 만료일 (일)', NOW(), NOW())
ON CONFLICT (config_key) DO NOTHING;
```

## 7. 설정 사용 예시

### 7.1 서비스에서 설정 사용

```java
@Service
public class PointAccumulationService {
    
    private final PointConfigService configService;
    
    public void accumulate(AccumulatePointRequest request) {
        // 설정 조회
        Long maxAmount = configService
            .getConfig("MAX_ACCUMULATION_AMOUNT_PER_TIME")
            .getLongValue();
        
        // 설정 값 사용
        if (request.getAmount() > maxAmount) {
            throw new ExceededMaxAccumulationException();
        }
        
        // ...
    }
}
```

### 7.2 설정 변경 시 영향도

#### 7.2.1 MAX_ACCUMULATION_AMOUNT_PER_TIME 변경
- **즉시 적용**: 다음 적립 요청부터 적용
- **기존 적립 건**: 영향 없음

#### 7.2.2 MAX_BALANCE_PER_MEMBER 변경
- **즉시 적용**: 다음 적립 요청부터 적용
- **기존 사용자**: 기존 잔액이 새로운 최대값을 초과하는 경우 처리 필요
  - 옵션 1: 기존 잔액은 그대로 유지, 추가 적립만 제한
  - 옵션 2: 기존 잔액도 새로운 최대값으로 제한 (비권장)

#### 7.2.3 DEFAULT_EXPIRATION_DAYS 변경
- **즉시 적용**: 다음 적립 요청부터 적용
- **기존 적립 건**: 영향 없음

## 8. 설정 모니터링

### 8.1 설정 변경 이력

설정 변경 시 이력을 기록합니다.

```java
@Entity
public class PointConfigHistory {
    private Long id;
    private String configKey;
    private String oldValue;
    private String newValue;
    private String changedBy;  // 변경한 사용자
    private LocalDateTime changedAt;
}
```

### 8.2 설정 변경 알림

중요한 설정 변경 시 알림을 발송합니다.

- `MAX_ACCUMULATION_AMOUNT_PER_TIME` 변경
- `MAX_BALANCE_PER_MEMBER` 변경
- `DEFAULT_EXPIRATION_DAYS` 변경

## 9. 다음 단계

다음 단계에서는 헥사고날 아키텍처 기반 프로젝트 구조를 구체화할 예정입니다.


