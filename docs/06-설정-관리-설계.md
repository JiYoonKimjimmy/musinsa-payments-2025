# 06. 설정 관리 설계

## 1. 개요

포인트 시스템의 동적 설정을 관리하는 방법을 설계합니다. 하드코딩이 아닌 별도의 방법으로 설정을 변경할 수 있도록 합니다.

## 2. 설정 항목

### 2.1 필수 설정 항목

| 설정 키                               | 설명           | 기본값      | 타입      | 범위             |
|------------------------------------|--------------|----------|---------|----------------|
| `MAX_ACCUMULATION_AMOUNT_PER_TIME` | 1회 최대 적립 금액  | 100000   | Long    | 1 이상           |
| `MAX_BALANCE_PER_MEMBER`           | 개인별 최대 보유 금액 | 10000000 | Long    | 1 이상           |
| `DEFAULT_EXPIRATION_DAYS`          | 기본 만료일 (일)   | 365      | Integer | 1 이상           |
| `MIN_EXPIRATION_DAYS`              | 최소 만료일 (일)   | 1        | Integer | 1 이상           |
| `MAX_EXPIRATION_DAYS`              | 최대 만료일 (일)   | 1824     | Integer | 1824 이하 (약 5년) |

### 2.2 설정 항목 상세

| 설정 키                               | 용도               | 검증 시점 | 변경 영향도              |
|------------------------------------|------------------|-------|---------------------|
| `MAX_ACCUMULATION_AMOUNT_PER_TIME` | 1회 적립 시 최대 금액 제한 | 적립 요청 | 다음 적립 요청부터 즉시 적용    |
| `MAX_BALANCE_PER_MEMBER`           | 개인별 최대 보유 포인트 제한 | 적립 요청 | 기존 잔액 유지, 추가 적립만 제한 |
| `DEFAULT_EXPIRATION_DAYS`          | 적립 시 기본 만료일      | 적립 요청 | 다음 적립 요청부터 적용       |
| `MIN_EXPIRATION_DAYS`              | 적립 시 만료일 최소값     | 적립 요청 | 다음 적립 요청부터 적용       |
| `MAX_EXPIRATION_DAYS`              | 적립 시 만료일 최대값     | 적립 요청 | 다음 적립 요청부터 적용       |

**설정 간 의존성**:
- `MIN_EXPIRATION_DAYS` < `DEFAULT_EXPIRATION_DAYS` < `MAX_EXPIRATION_DAYS`

---

## 3. 설정 저장소 설계

### 3.1 데이터베이스 기반 설정

설정을 데이터베이스 테이블(`point_config`)에 저장하여 동적으로 관리합니다.

**장점**:
- 런타임에 설정 변경 가능
- 설정 변경 이력 관리 가능
- 여러 환경(개발/스테이징/운영)별 설정 관리 가능

**단점**:
- 데이터베이스 의존성
- 설정 조회 시 데이터베이스 접근 필요 (캐싱으로 해결)

### 3.2 설정 조회 전략

#### 3.2.1 캐싱 전략

Spring Cache 어노테이션을 활용하여 설정 값을 메모리에 캐싱합니다.

**캐싱 어노테이션**:

| 어노테이션       | 적용 위치             | 캐시 키                      | 설명                  |
|-------------|-------------------|---------------------------|---------------------|
| @Cacheable  | findByConfigKey() | `#configKey`              | 키별 설정 캐싱            |
| @Cacheable  | findAll()         | `'all'`                   | 전체 설정 캐싱            |
| @Cacheable  | getLongValue()    | `#configKey + ':long'`    | Long 타입 변환 결과 캐싱    |
| @Cacheable  | getIntValue()     | `#configKey + ':int'`     | Int 타입 변환 결과 캐싱     |
| @Cacheable  | getBooleanValue() | `#configKey + ':boolean'` | Boolean 타입 변환 결과 캐싱 |
| @CacheEvict | updateConfig()    | `allEntries = true`       | 설정 업데이트 시 전체 캐시 무효화 |

#### 3.2.2 캐시 무효화 전략

- **즉시 무효화**: 설정 변경 시 `@CacheEvict(allEntries = true)`로 전체 캐시 무효화
- **이유**: 설정 간 의존성이 있어 개별 키 무효화보다 전체 무효화가 안전

#### 3.2.3 설정 변경 플로우

```
UpdateConfigRequest 요청
    ↓
PointConfigService.updateConfig()
    ↓
PointConfigValidator.validateConfigValue()      ← 개별 값 검증
    ↓
PointConfig.updateConfigValue()                 ← 도메인 엔티티 업데이트
    ↓
PointConfigPort.save()                          ← DB 저장
    ↓
@CacheEvict (자동)                               ← 캐시 무효화
    ↓
PointConfigHistoryPort.save()                   ← 변경 이력 기록
    ↓
PointConfigValidator.validateConfigDependencies() ← 설정 간 의존성 검증 (만료일 관련)
    ↓
UpdateConfigResponse 응답
```

---

## 4. 설정 관리 API

### 4.1 설정 조회 API

#### GET /api/admin/points/config

**설명**: 모든 포인트 설정을 조회합니다.

**Response Body**:
```json
{
  "success": true,
  "data": [
    {
      "configKey": "MAX_ACCUMULATION_AMOUNT_PER_TIME",
      "configValue": "100000",
      "description": "1회 최대 적립 금액",
      "updatedAt": "2025-01-01T10:00:00"
    },
    {
      "configKey": "MAX_BALANCE_PER_MEMBER",
      "configValue": "10000000",
      "description": "개인별 최대 보유 금액",
      "updatedAt": "2025-01-01T10:00:00"
    }
  ],
  "message": "설정 조회에 성공했습니다."
}
```

#### GET /api/admin/points/config/{configKey}

**설명**: 특정 설정을 조회합니다.

**Path Parameter**:
- `configKey`: 설정 키

**에러 케이스**:
- `404 CONFIG_NOT_FOUND`: 설정을 찾을 수 없음

### 4.2 설정 업데이트 API

#### PUT /api/admin/points/config/{configKey}

**설명**: 특정 설정 값을 업데이트합니다.

**Path Parameter**:
- `configKey`: 설정 키

**Request Body**:
```json
{
  "configValue": "200000",
  "description": "1회 최대 적립 금액 (업데이트)"
}
```

**Response Body**:
```json
{
  "success": true,
  "data": {
    "configKey": "MAX_ACCUMULATION_AMOUNT_PER_TIME",
    "configValue": "200000",
    "description": "1회 최대 적립 금액 (업데이트)",
    "updatedAt": "2025-01-01T11:00:00"
  },
  "message": "설정이 성공적으로 업데이트되었습니다."
}
```

**에러 케이스**:

| 에러 코드                  | HTTP 상태 | 설명            |
|------------------------|---------|---------------|
| `CONFIG_NOT_FOUND`     | 404     | 설정을 찾을 수 없음   |
| `INVALID_CONFIG_KEY`   | 400     | 유효하지 않은 설정 키  |
| `INVALID_CONFIG_VALUE` | 400     | 설정 값이 유효하지 않음 |

---

## 5. 설정 검증 로직

### 5.1 PointConfigValidator

**책임**:
- 설정 값 유효성 검증
- 설정 간 의존성 검증

**검증 규칙**:

| 설정 키                             | 검증 타입 | 범위                 |
|----------------------------------|-------|--------------------|
| MAX_ACCUMULATION_AMOUNT_PER_TIME | Long  | 1 ~ Long.MAX_VALUE |
| MAX_BALANCE_PER_MEMBER           | Long  | 1 ~ Long.MAX_VALUE |
| DEFAULT_EXPIRATION_DAYS          | Int   | 1 ~ 1824           |
| MIN_EXPIRATION_DAYS              | Int   | 1 ~ 1824           |
| MAX_EXPIRATION_DAYS              | Int   | 1 ~ 1824           |

**주요 기능**:

| 메서드                             | 설명                                |
|---------------------------------|-----------------------------------|
| validateConfigValue(key, value) | 개별 설정 값 유효성 검증                    |
| validateConfigDependencies()    | 설정 간 의존성 검증 (MIN < DEFAULT < MAX) |

### 5.2 의존성 검증 규칙

```
MIN_EXPIRATION_DAYS < DEFAULT_EXPIRATION_DAYS < MAX_EXPIRATION_DAYS
```

- 최소 만료일은 최대 만료일보다 작아야 함
- 기본 만료일은 최소 만료일 이상, 최대 만료일 미만이어야 함

---

## 6. 초기 설정 데이터

### 6.1 DataInitializer

애플리케이션 시작 시 기본 설정 값이 없으면 자동으로 생성합니다.

**구현 방식**:
- `CommandLineRunner` 인터페이스 구현
- 애플리케이션 시작 시 자동 실행
- 이미 존재하는 설정은 건너뛰고, 존재하지 않는 설정만 생성

**초기화 설정 목록**:

| 설정 키                             | 기본값      | 설명               |
|----------------------------------|----------|------------------|
| MAX_ACCUMULATION_AMOUNT_PER_TIME | 100000   | 1회 최대 적립 금액      |
| MAX_BALANCE_PER_MEMBER           | 10000000 | 개인별 최대 보유 금액     |
| DEFAULT_EXPIRATION_DAYS          | 365      | 기본 만료일 (일)       |
| MIN_EXPIRATION_DAYS              | 1        | 최소 만료일 (일)       |
| MAX_EXPIRATION_DAYS              | 1824     | 최대 만료일 (일, 약 5년) |

**초기화 로그**:
```
데이터베이스 초기화를 시작합니다...
설정 'MAX_ACCUMULATION_AMOUNT_PER_TIME' (값: '100000', 설명: '1회 최대 적립 금액') 초기화 완료
설정 초기화 완료: 신규 생성 5개, 기존 유지 0개
데이터베이스 초기화를 완료했습니다.
```

---

## 7. 설정 서비스

### 7.1 PointConfigService

**책임**:
- 설정 조회 (캐싱 적용)
- 설정 업데이트
- 설정 변경 이력 기록

**의존성**:

| 의존 컴포넌트                |   | 용도       |
|------------------------|:--|----------|
| PointConfigPort        |   | 설정 저장/조회 |
| PointConfigValidator   |   | 설정 값 검증  |
| PointConfigHistoryPort |   | 변경 이력 저장 |

**제공 메서드**:

| 메서드                  | 캐싱 여부  | 설명                 |
|----------------------|--------|--------------------|
| findByConfigKey(key) | ✅      | 설정 키로 조회           |
| findAll()            | ✅      | 모든 설정 조회           |
| getLongValue(key)    | ✅      | Long 타입 설정 값 조회    |
| getIntValue(key)     | ✅      | Int 타입 설정 값 조회     |
| getBooleanValue(key) | ✅      | Boolean 타입 설정 값 조회 |
| updateConfig(...)    | 캐시 무효화 | 설정 업데이트 및 이력 기록    |

### 7.2 설정 사용 방식

서비스에서 설정을 사용하는 흐름:

| 단계 | 처리 내용                                     |
|----|-------------------------------------------|
| 1  | `PointConfigService.getLongValue(key)` 호출 |
| 2  | 캐시에서 조회 (캐시 히트 시 바로 반환)                   |
| 3  | 캐시 미스 시 DB 조회 후 캐시 저장                     |
| 4  | Long 타입으로 변환하여 반환                         |

---

## 8. 설정 모니터링

### 8.1 설정 변경 이력

설정 변경 시 `PointConfigHistory` 엔티티에 이력을 기록합니다.

**기록 항목**:

| 필드        | 설명           |
|-----------|--------------|
| configKey | 설정 키         |
| oldValue  | 변경 전 값       |
| newValue  | 변경 후 값       |
| changedBy | 변경한 사용자 (선택) |
| changedAt | 변경 일시        |

### 8.2 설정 변경 시 고려사항

| 설정 키                             | 변경 시 주의사항                   |
|----------------------------------|-----------------------------|
| MAX_ACCUMULATION_AMOUNT_PER_TIME | 즉시 적용, 기존 적립 건 영향 없음        |
| MAX_BALANCE_PER_MEMBER           | 기존 잔액이 새 최대값 초과 시 추가 적립만 제한 |
| DEFAULT_EXPIRATION_DAYS          | 즉시 적용, 기존 적립 건 영향 없음        |
| MIN_EXPIRATION_DAYS              | 설정 간 의존성 검증 필요              |
| MAX_EXPIRATION_DAYS              | 설정 간 의존성 검증 필요              |

---

## 9. 다음 단계

다음 단계에서는 헥사고날 아키텍처 기반 프로젝트 구조를 구체화할 예정입니다.

---

**다음 문서**: [07. 프로젝트 구조 설계](./07-프로젝트-구조-설계.md)
