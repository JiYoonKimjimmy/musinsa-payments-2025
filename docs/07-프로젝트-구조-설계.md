# 07. 프로젝트 구조 설계 (헥사고날 아키텍처)

## 1. 개요

헥사고날 아키텍처(Hexagonal Architecture)를 적용하여 포인트 시스템의 프로젝트 구조를 설계합니다. 도메인 중심 설계로 비즈니스 로직과 인프라스트럭처를 분리합니다.

## 2. 헥사고날 아키텍처 개요

### 2.1 아키텍처 특징

| 특징      | 설명                     |
|---------|------------------------|
| 도메인 중심  | 비즈니스 로직이 도메인 레이어에 집중   |
| 의존성 역전  | 도메인이 인프라스트럭처에 의존하지 않음  |
| 포트와 어댑터 | 포트(인터페이스)와 어댑터(구현)로 분리 |

### 2.2 레이어 구조

```
┌─────────────────────────────────────┐
│   Presentation (프레젠테이션)         │
│  (Web Controller, DTO, Exception)   │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│   Application (애플리케이션)          │
│  (UseCase, Port, Service, Event)    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│         Domain (도메인)              │
│  (Entity, ValueObject, Service,     │
│   Event, Exception)                 │
└─────────────────────────────────────┘
              ↑
┌─────────────────────────────────────┐
│  Infrastructure (인프라스트럭처)       │
│  (Persistence, Config, Event, Key)  │
└─────────────────────────────────────┘
```

### 2.3 레이어별 역할

| 레이어            | 역할            | 포함 요소                                                |
|----------------|---------------|------------------------------------------------------|
| Domain         | 핵심 비즈니스 로직    | Entity, ValueObject, DomainService, Event, Exception |
| Application    | 유스케이스 조합 및 조율 | Port(Input/Output), Service, EventHandler            |
| Infrastructure | 외부 시스템과의 통신   | Persistence, Config, Event, Key 어댑터                  |
| Presentation   | 사용자 인터페이스     | Controller, DTO, ExceptionHandler                    |

---

## 3. 프로젝트 구조

### 3.1 전체 패키지 구조

```
com.musinsa.payments.point
├── domain                              # 도메인 레이어
│   ├── entity                          # 도메인 엔티티 및 Enum
│   │   ├── PointAccumulation.kt
│   │   ├── PointUsage.kt
│   │   ├── PointUsageDetail.kt
│   │   ├── PointConfig.kt
│   │   ├── PointConfigHistory.kt
│   │   ├── MemberPointBalance.kt
│   │   ├── PointAccumulationStatus.kt
│   │   ├── PointUsageStatus.kt
│   │   └── CancellationType.kt
│   ├── valueobject                     # 값 객체
│   │   ├── Money.kt
│   │   ├── OrderNumber.kt
│   │   └── PointKey.kt
│   ├── service                         # 도메인 서비스
│   │   └── PointUsagePriorityService.kt
│   ├── event                           # 도메인 이벤트
│   │   ├── PointBalanceEvent.kt
│   │   └── BalanceReconciliationRequestEvent.kt
│   └── exception                       # 도메인 예외
│       ├── PointDomainException.kt
│       ├── InsufficientPointException.kt
│       ├── CannotCancelAccumulationException.kt
│       ├── CannotCancelUsageException.kt
│       ├── InvalidAmountException.kt
│       ├── MaxAccumulationExceededException.kt
│       ├── MaxBalanceExceededException.kt
│       ├── InvalidExpirationDateException.kt
│       ├── ConfigNotFoundException.kt
│       ├── InvalidConfigKeyException.kt
│       ├── InvalidConfigValueException.kt
│       └── PointExpiredException.kt
│
├── application                         # 애플리케이션 레이어
│   ├── port                            # 포트 인터페이스
│   │   ├── input                       # 인바운드 포트 (UseCase)
│   │   │   ├── PointAccumulationUseCase.kt
│   │   │   ├── PointUsageUseCase.kt
│   │   │   ├── PointCancellationUseCase.kt
│   │   │   └── PointQueryUseCase.kt
│   │   └── output                      # 아웃바운드 포트
│   │       ├── persistence             # 영속성 포트
│   │       │   ├── PointAccumulationPersistencePort.kt
│   │       │   ├── PointUsagePersistencePort.kt
│   │       │   ├── PointUsageDetailPersistencePort.kt
│   │       │   └── MemberPointBalancePersistencePort.kt
│   │       ├── config                  # 설정 포트
│   │       │   ├── PointConfigPort.kt
│   │       │   └── PointConfigHistoryPort.kt
│   │       ├── event                   # 이벤트 포트
│   │       │   └── PointBalanceEventPublisher.kt
│   │       └── PointKeyGenerator.kt    # 키 생성 포트
│   ├── service                         # 애플리케이션 서비스
│   │   ├── PointAccumulationService.kt
│   │   ├── PointUsageService.kt
│   │   ├── PointCancellationService.kt
│   │   ├── PointQueryService.kt
│   │   ├── PointConfigService.kt
│   │   ├── PointConfigValidator.kt
│   │   ├── PointBalanceCacheUpdateService.kt
│   │   └── PointBalanceReconciliationService.kt
│   └── event                           # 이벤트 핸들러
│       ├── PointBalanceEventHandler.kt
│       └── BalanceReconciliationEventHandler.kt
│
├── infrastructure                      # 인프라스트럭처 레이어
│   ├── persistence                     # 영속성 구현
│   │   ├── jpa                         # JPA 구현
│   │   │   ├── entity                  # JPA 엔티티
│   │   │   │   ├── PointAccumulationEntity.kt
│   │   │   │   ├── PointUsageEntity.kt
│   │   │   │   ├── PointUsageDetailEntity.kt
│   │   │   │   ├── PointConfigEntity.kt
│   │   │   │   ├── PointConfigHistoryEntity.kt
│   │   │   │   └── MemberPointBalanceEntity.kt
│   │   │   ├── repository              # JPA 리포지토리
│   │   │   │   ├── PointAccumulationJpaRepository.kt
│   │   │   │   ├── PointUsageJpaRepository.kt
│   │   │   │   ├── PointUsageDetailJpaRepository.kt
│   │   │   │   ├── PointConfigJpaRepository.kt
│   │   │   │   ├── PointConfigHistoryJpaRepository.kt
│   │   │   │   └── MemberPointBalanceJpaRepository.kt
│   │   │   └── mapper                  # 엔티티 매퍼
│   │   │       └── PointEntityMapper.kt
│   │   └── adapter                     # 영속성 어댑터
│   │       ├── PointAccumulationPersistenceAdapter.kt
│   │       ├── PointUsagePersistenceAdapter.kt
│   │       ├── PointUsageDetailPersistenceAdapter.kt
│   │       └── MemberPointBalancePersistenceAdapter.kt
│   ├── config                          # 설정 어댑터 및 구성
│   │   ├── PointConfigAdapter.kt
│   │   ├── PointConfigHistoryAdapter.kt
│   │   ├── DataInitializer.kt
│   │   ├── AsyncConfig.kt
│   │   ├── CacheConfig.kt
│   │   └── RetryConfig.kt
│   ├── event                           # 이벤트 어댑터
│   │   └── SpringPointBalanceEventPublisher.kt
│   └── key                             # 키 생성 어댑터
│       └── UUIDPointKeyGenerator.kt
│
└── presentation                        # 프레젠테이션 레이어
    └── web                             # 웹 어댑터
        ├── controller                  # REST 컨트롤러
        │   ├── PointAccumulationController.kt
        │   ├── PointUsageController.kt
        │   ├── PointCancellationController.kt
        │   ├── PointQueryController.kt
        │   ├── PointConfigController.kt
        │   └── PointReconciliationController.kt
        ├── dto                         # 요청/응답 DTO
        │   ├── request
        │   │   ├── AccumulatePointRequest.kt
        │   │   ├── UsePointRequest.kt
        │   │   ├── CancelAccumulationRequest.kt
        │   │   ├── CancelUsageRequest.kt
        │   │   ├── UpdateConfigRequest.kt
        │   │   └── PageRequest.kt
        │   └── response
        │       ├── BaseResponse.kt
        │       ├── AccumulatePointResponse.kt
        │       ├── UsePointResponse.kt
        │       ├── CancelAccumulationResponse.kt
        │       ├── CancelUsageResponse.kt
        │       ├── PointBalanceResponse.kt
        │       ├── PointUsageHistoryResponse.kt
        │       ├── PointConfigResponse.kt
        │       ├── ReconciliationResultResponse.kt
        │       ├── ReconciliationSummaryResponse.kt
        │       └── PageResponse.kt
        ├── exception                   # 예외 핸들러
        │   └── GlobalExceptionHandler.kt
        └── mapper                      # DTO 매퍼
            └── PointDtoMapper.kt
```

---

## 4. 레이어별 상세 설계

### 4.1 Domain 레이어

| 패키지         | 설명             | 주요 특징                    |
|-------------|----------------|--------------------------|
| entity      | 도메인 엔티티 및 Enum | 비즈니스 로직 포함, JPA 어노테이션 없음 |
| valueobject | 값 객체           | 불변 객체, 값 비교 로직 포함        |
| service     | 도메인 서비스        | 순수 비즈니스 로직, 트랜잭션 관리 없음   |
| event       | 도메인 이벤트        | 도메인에서 발생하는 이벤트 정의        |
| exception   | 도메인 예외         | 비즈니스 규칙 위반 시 발생하는 예외     |

**도메인 레이어 원칙**:
- 다른 레이어에 의존하지 않는 독립적인 레이어
- JPA 어노테이션 없이 순수 도메인 모델 유지
- 비즈니스 규칙 검증 메서드 포함

### 4.2 Application 레이어

| 패키지         | 설명         | 주요 특징                      |
|-------------|------------|----------------------------|
| port/input  | 인바운드 포트    | UseCase 인터페이스, 서비스가 구현     |
| port/output | 아웃바운드 포트   | 영속성/설정/이벤트 인터페이스, 인프라에서 구현 |
| service     | 애플리케이션 서비스 | UseCase 구현, 트랜잭션 관리, 포트 호출 |
| event       | 이벤트 핸들러    | 도메인 이벤트 처리, 비동기 처리         |

**애플리케이션 레이어 원칙**:
- 포트 인터페이스를 통한 의존성 역전
- 트랜잭션 경계 정의
- 도메인 서비스 조합

### 4.3 Infrastructure 레이어

| 패키지                 | 설명          | 주요 특징                   |
|---------------------|-------------|-------------------------|
| persistence/jpa     | JPA 구현      | JPA 엔티티, 리포지토리, 매퍼      |
| persistence/adapter | 영속성 어댑터     | 아웃바운드 포트 구현             |
| config              | 설정 어댑터 및 구성 | 설정 포트 구현, Spring Config |
| event               | 이벤트 어댑터     | 이벤트 발행 포트 구현            |
| key                 | 키 생성 어댑터    | PointKey 생성 포트 구현       |

**인프라스트럭처 레이어 원칙**:
- 아웃바운드 포트 인터페이스 구현
- JPA 엔티티 ↔ 도메인 엔티티 변환
- 외부 시스템 통신 담당

### 4.4 Presentation 레이어

| 패키지        | 설명        | 주요 특징                     |
|------------|-----------|---------------------------|
| controller | REST 컨트롤러 | HTTP 요청/응답 처리, UseCase 호출 |
| dto        | 요청/응답 DTO | API 스펙 정의, 검증 어노테이션       |
| exception  | 예외 핸들러    | 전역 예외 처리, HTTP 상태 매핑      |
| mapper     | DTO 매퍼    | DTO ↔ 도메인 모델 변환           |

**프레젠테이션 레이어 원칙**:
- 인바운드 포트(UseCase) 호출
- HTTP 요청/응답 변환
- API 문서화 (Swagger)

---

## 5. 의존성 방향

### 5.1 의존성 규칙

```
Presentation → Application → Domain
              ↓                 ↑
              └── port.output ──┘
                        ↑
Infrastructure ─────────┘
```

### 5.2 의존성 상세

| 의존 관계                                    | 설명                  |
|------------------------------------------|---------------------|
| Presentation → Application.port.input    | 인바운드 포트(UseCase) 호출 |
| Application → Domain                     | 도메인 모델 사용           |
| Application → Application.port.output    | 아웃바운드 포트 인터페이스에 의존  |
| Infrastructure → Application.port.output | 아웃바운드 포트 인터페이스 구현   |
| Infrastructure → Domain                  | 도메인 모델 변환 시 사용      |

### 5.3 의존성 금지

| 금지 의존 관계                      | 이유                       |
|-------------------------------|--------------------------|
| Domain → Application          | 도메인은 애플리케이션에 의존하지 않음     |
| Domain → Infrastructure       | 도메인은 인프라에 의존하지 않음        |
| Domain → Presentation         | 도메인은 프레젠테이션에 의존하지 않음     |
| Application → Infrastructure  | 포트 인터페이스만 의존 (구현체 의존 금지) |
| Presentation → Infrastructure | 프레젠테이션은 인프라에 직접 의존하지 않음  |

---

## 6. 주요 컴포넌트 연결

### 6.1 포인트 적립 흐름

```
[Controller] → [PointAccumulationUseCase] → [PointAccumulationService]
                                                      ↓
                                           [PointAccumulationPersistencePort]
                                                      ↓
                                           [PointAccumulationPersistenceAdapter]
                                                      ↓
                                           [PointAccumulationJpaRepository]
```

### 6.2 잔액 이벤트 흐름

```
[PointAccumulationService] → [PointBalanceEventPublisher] → [SpringPointBalanceEventPublisher]
                                                                        ↓
                                                            [ApplicationEventPublisher]
                                                                        ↓
                                                            [PointBalanceEventHandler]
                                                                        ↓
                                                            [PointBalanceCacheUpdateService]
                                                                        ↓
                                                            [MemberPointBalancePersistencePort]
```

---

## 7. 설정 파일 구조

### 7.1 리소스 구조

```
src/main/resources/
├── application.yml              # 메인 설정
└── (optional)
    ├── application-dev.yml      # 개발 환경 설정
    ├── application-prod.yml     # 운영 환경 설정
    └── db/migration/            # Flyway/Liquibase 마이그레이션
```

### 7.2 주요 설정 항목

| 설정 영역   | 내용                          |
|---------|-----------------------------|
| JPA     | 배치 처리 설정, DDL 옵션            |
| H2      | 인메모리 DB (개발/테스트용)           |
| 비동기     | Virtual Thread, Thread Pool |
| 캐시      | Spring Cache 설정             |
| 재시도     | Spring Retry 설정             |
| Swagger | API 문서화 설정                  |

---

## 8. 테스트 구조

### 8.1 테스트 패키지 구조

```
src/test/kotlin/com/musinsa/payments/point/
├── application/
│   ├── service/                # 서비스 단위 테스트
│   ├── event/                  # 이벤트 핸들러 테스트
│   └── integration/            # 통합 테스트 (시나리오 테스트)
├── domain/
│   ├── entity/                 # 엔티티 단위 테스트
│   ├── valueobject/            # 값 객체 단위 테스트
│   └── service/                # 도메인 서비스 테스트
├── infrastructure/
│   ├── persistence/            # 영속성 어댑터 통합 테스트
│   └── config/                 # 설정 어댑터 테스트
└── presentation/
    └── web/controller/         # 컨트롤러 테스트

src/testFixtures/kotlin/com/musinsa/payments/point/
└── application/port/output/    # Fake 구현체 (테스트용 목 객체)
```

### 8.2 테스트 전략

| 레이어            | 테스트 방식      | 특징                       |
|----------------|-------------|--------------------------|
| Domain         | 단위 테스트      | 순수 로직 검증, 의존성 없음         |
| Application    | 단위/통합 테스트   | Fake 구현체 활용, 시나리오 검증     |
| Infrastructure | 통합 테스트      | @DataJpaTest 등 Spring 활용 |
| Presentation   | MockMvc 테스트 | API 스펙 검증                |

---

## 9. 다음 단계

다음 단계에서는 AWS 아키텍처 설계를 통해 클라우드 환경에서의 배포 구조를 설계할 예정입니다.

---

**다음 문서**: [08. AWS 아키텍처 설계](./08-AWS-아키텍처-설계.md)
